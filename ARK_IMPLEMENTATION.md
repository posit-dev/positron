# Implementing Format Options in the R Backend (ark)

This document describes the changes needed in the ark repository to make the data explorer respect R's `scipen` option.

## Background

The R `scipen` option controls the penalty for switching to scientific notation:
- `scipen = 0` (default): balanced use of scientific notation
- `scipen > 0`: prefer fixed notation (higher values = more preference)
- `scipen < 0`: prefer scientific notation

The option works by adding a penalty to the number of digits. The switch to scientific notation happens when:
```
log10(abs(x)) >= (digits + scipen)
```

Where `digits` is typically 7 for the integral part.

## Changes Required in ark

### 1. Update the BackendState structure

In the ark data explorer backend implementation, the `BackendState` structure needs to include the optional `format_options` field.

The corresponding Rust structure should be updated (this was auto-generated by the comms generator):

```rust
pub struct FormatOptions {
    pub large_num_digits: i64,
    pub small_num_digits: i64,
    pub max_integral_digits: i64,
    pub max_value_length: i64,
    pub thousands_sep: Option<String>,
}

pub struct BackendState {
    // ... existing fields ...
    pub format_options: Option<FormatOptions>,
}
```

### 2. Implement format option calculation

In the R backend's `get_state` method, calculate the format options based on R's `scipen`:

```r
get_format_options <- function() {
  # Get R's scipen option (default is 0)
  scipen <- getOption("scipen", default = 0)
  
  # Calculate max_integral_digits based on scipen
  # Default threshold is 7 digits
  # Each unit of scipen adds 1 to the threshold
  max_integral_digits <- 7 + scipen
  
  # Ensure reasonable bounds (e.g., 1 to 20)
  max_integral_digits <- max(1, min(20, max_integral_digits))
  
  list(
    large_num_digits = 2,        # Decimal places for large numbers
    small_num_digits = 4,        # Decimal places for small numbers
    max_integral_digits = max_integral_digits,
    max_value_length = 1000,     # Max length for formatted values
    thousands_sep = NULL         # No thousands separator by default
  )
}
```

### 3. Include format_options in get_state response

When returning the backend state, include the format options:

```r
get_state <- function() {
  # ... calculate other state fields ...
  
  list(
    display_name = variable_name,
    table_shape = table_shape,
    # ... other fields ...
    format_options = get_format_options()
  )
}
```

## Example Scenarios

### Default behavior (scipen = 0)
- `max_integral_digits = 7`
- Numbers like 1000000 display in fixed notation
- Numbers like 10000000 switch to scientific notation (1.00e+07)

### Prefer fixed notation (scipen = 5)
- `max_integral_digits = 12`
- Numbers like 100000000000 display in fixed notation
- Larger numbers switch to scientific notation

### Prefer scientific notation (scipen = -3)
- `max_integral_digits = 4`
- Numbers like 10000 switch to scientific notation (1.00e+04)

## Testing

After implementing these changes:

1. Test with default R settings:
   ```r
   df <- data.frame(x = c(1000000, 10000000, 100000000))
   View(df)  # Open in data explorer
   ```

2. Test with high scipen:
   ```r
   options(scipen = 10)
   df <- data.frame(x = c(1e10, 1e15, 1e20))
   View(df)
   ```

3. Test with negative scipen:
   ```r
   options(scipen = -5)
   df <- data.frame(x = c(100, 1000, 10000))
   View(df)
   ```

## Related Issues

- Original issue: https://github.com/posit-dev/positron/issues/4818
- Rejected PR (global option): https://github.com/posit-dev/positron/pull/7266

## Notes

- The format_options field is optional, so existing backends will continue to work
- If not provided, the frontend uses sensible defaults (max_integral_digits = 7)
- The Python backend can similarly be extended to respect pandas display options
