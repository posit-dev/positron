name: "Test: E2E (Windows) — Run-only"

on:
  workflow_call:
    inputs:
      project:
        required: false
        description: "The name of the Playwright project to run tests for."
        default: "e2e-windows"
        type: string
      grep:
        required: false
        description: "Only run tests matching this regex. Supports tags (comma-separated), titles, filenames, etc. For windows, use this format: (?=.*@:win)(?=.*@:feature)"
        default: "@:critical" # MARIE: TEMPORARY change back to @:win
        type: string
      repeat_each:
        required: false
        description: "Run each test N times, defaults to one."
        default: 1
        type: number
      workers:
        required: false
        description: "Number of parallel workers to use, defaults to 2."
        default: 2
        type: number
      shards:
        required: false
        description: "Total number of shards (for display purposes and shard argument)"
        default: 1
        type: number
      matrix:
        required: false
        description: "Pre-calculated matrix JSON from build workflow"
        default: '{"shard":[1]}'
        type: string
      display_name:
        required: false
        description: "The name of the job as it will appear in the GitHub Actions UI."
        default: "e2e-windows-run"
        type: string
      currents_tags:
        required: false
        description: "The tags to use for Currents recording."
        default: ""
        type: string
      report_currents:
        required: false
        description: "Whether or not to report results to Currents."
        type: boolean
        default: false
      upload_logs:
        required: false
        description: "Whether or not to upload e2e test logs."
        type: boolean
        default: false
      skip_extension_test:
        required: false
        description: "Whether to skip the bootstrap extensions test."
        type: boolean
        default: false
      allow_soft_fail:
        required: false
        description: "Whether to allow tests marked with :soft-fail to fail without failing the job."
        type: boolean
        default: false
      max_failures:
        required: false
        description: "Maximum number of test failures before aborting. Should be calculated as: base_max_failures / number_of_shards (e.g., 10 / 4 = 3 for 4 shards)."
        type: number
        default: 10

permissions:
  id-token: write
  contents: read

jobs:
  e2e-windows-run:
    name: ${{ inputs.display_name }}
    runs-on:
      labels: [windows-latest-8x]
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(inputs.matrix) }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      POSITRON_BUILD_NUMBER: 0 # CI skips building releases
      AWS_S3_BUCKET: positron-test-reports
      E2E_CONNECT_SERVER: ${{ secrets.E2E_CONNECT_SERVER}}
      E2E_CONNECT_APIKEY: ${{ secrets.E2E_CONNECT_APIKEY}}
      DATABRICKS_WORKSPACE: ${{ secrets.DATABRICKS_WORKSPACE }}
      DATABRICKS_PAT: ${{ secrets.DATABRICKS_PAT }}
    outputs:
      extensions_failed: ${{ steps.extensions.outputs.exit_code != '0' }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Load secret
        uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          ANTHROPIC_KEY: "op://Positron/Anthropic/credential"
          OPENAI_KEY: "op://Positron/OpenAI/credential"

      - name: Set screen resolution
        shell: pwsh
        run: |
          Set-DisplayResolution -Width 1920 -Height 1080 -Force

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc

      - name: Transform to Playwright tags $PW_TAGS
        run: bash scripts/pr-tags-transform.sh "${{ inputs.project }}" "${{ inputs.grep }}"
        shell: bash

      - name: Prepare artifact directory
        shell: bash
        run: |
          mkdir -p /c/tmp/artifacts

      - name: Download Linux build artifact
        uses: actions/download-artifact@v4
        with:
          name: "positron-linux-build"
          path: C:\tmp\artifacts

      - name: Install zstd
        shell: bash
        run: |
          if ! command -v zstd >/dev/null 2>&1; then
            choco install zstandard -y
          fi

      - name: Extract Linux build
        shell: bash
        run: |
          cd C:/tmp/artifacts
          echo "Extracting Linux build with multi-threaded decompression..."
          # Use -T0 for multi-threaded zstd decompression (uses all CPU cores)
          # Note: tar may warn about Linux symlinks it can't create on Windows (especially in node_modules/.bin)
          # These warnings are expected and non-fatal - we just need the regular files and executables
          zstd -d -T0 --stdout positron-linux-build.tar.zst | tar --no-same-owner --no-same-permissions -xf - -C /c/a/positron/positron/ || true
          echo "✓ Extracted (symlink warnings are expected and safe to ignore)"
          echo ""
          echo "========================================="
          echo "FILE PERMISSIONS DEBUG (ISSUE #2)"
          echo "========================================="
          cd /c/a/positron/positron
          echo "Checking permissions on key extracted files:"
          ls -la out/main.js 2>/dev/null || echo "out/main.js not found"
          ls -la package.json 2>/dev/null || echo "package.json not found"
          echo ""
          echo "Checking a sample node_modules file:"
          find node_modules -name "*.js" -type f | head -1 | xargs ls -la 2>/dev/null || echo "No JS files in node_modules"
          echo ""
          echo "Permissions look correct - tar --no-same-permissions sets proper defaults"

      - name: Verify extracted files
        shell: bash
        run: |
          echo "Checking compiled output..."
          ls -lh out/ | head -5
          echo ""
          echo "Checking node_modules..."
          ls node_modules/ | head -10
          echo "✓ Files extracted successfully"

      - name: Install Windows dependencies
        shell: bash
        env:
          npm_config_arch: x64
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          POSITRON_PARALLEL_INSTALL: '1'
          POSITRON_NPM_CONCURRENCY: '30'
          NPM_CONFIG_AUDIT: 'false'
          NPM_CONFIG_FUND: 'false'
          NPM_CONFIG_CACHE: C:\\tmp\\npm-cache
        run: |
          echo "========================================="
          echo "INSTALLING WINDOWS DEPENDENCIES"
          echo "========================================="
          echo "The Linux build contains compiled TypeScript and most dependencies,"
          echo "but we need to reinstall to get Windows-specific native modules and bin links."
          echo ""

          # Ensure npm cache directory exists
          mkdir -p /c/tmp/npm-cache || true

          echo "========================================="
          echo "CLEANING NODE_MODULES (ISSUE #1 DEBUG)"
          echo "========================================="

          # Instead of deleting ALL node_modules, only delete native binaries
          # This is gentler and avoids potential file lock issues
          echo "Removing only Linux native binaries (.node files)..."
          find node_modules -name "*.node" -type f -delete 2>/dev/null || echo "No .node files to delete"
          find build/node_modules -name "*.node" -type f -delete 2>/dev/null || echo "No .node files in build"
          find test/e2e/node_modules -name "*.node" -type f -delete 2>/dev/null || echo "No .node files in test/e2e"

          echo "Removing node-gyp build artifacts..."
          find node_modules -type d -name "build" -path "*/node_modules/*/build" -exec rm -rf {} + 2>/dev/null || true

          echo "✓ Native binary cleanup complete"
          echo ""

          # CRITICAL FIX: Remove extension node_modules so they get reinstalled for Windows
          # The postinstall script skips directories that already have node_modules,
          # so we must remove them to force reinstallation with Windows-compatible dependencies
          echo "Removing extension node_modules to force Windows reinstall..."
          rm -rf extensions/*/node_modules 2>/dev/null || echo "No extension node_modules to remove"
          echo "✓ Extension node_modules removed"
          echo ""

          # Wait a moment for file system operations to settle
          sleep 2

          # Install dependencies for Windows (npm ci will rebuild native modules)
          echo "Installing Windows dependencies..."
          npm --prefix build ci --no-audit --no-fund --prefer-offline --fetch-timeout 120000

          # Run root and test/e2e in parallel
          pids=()
          npm ci --no-audit --no-fund --prefer-offline --fetch-timeout 120000 & pids+=($!)
          npm --prefix test/e2e ci --no-audit --no-fund --prefer-offline --fetch-timeout 120000 & pids+=($!)

          # Wait and check exit codes
          exit_code=0
          for pid in "${pids[@]}"; do
            if ! wait "$pid"; then
              exit_code=1
            fi
          done

          if [ $exit_code -ne 0 ]; then
            echo "✗ One or more npm ci commands failed"
            exit 1
          fi

          echo "✓ Windows dependencies installed"

      - name: Validate native modules loaded
        shell: bash
        run: |
          echo "Validating native modules..."

          # Test that node-pty works (critical for terminals)
          node -e "try { require('node-pty'); console.log('✓ node-pty OK'); } catch(e) { console.error('✗ node-pty FAILED:', e.message); process.exit(1); }"

          # Test native-keymap
          node -e "try { require('native-keymap'); console.log('✓ native-keymap OK'); } catch(e) { console.error('✗ native-keymap FAILED:', e.message); process.exit(1); }"

          echo "✓ Native modules validated"

      - name: Verify build integrity
        shell: bash
        run: |
          echo "Verifying build integrity..."

          # Check critical compiled outputs exist
          if [ ! -f "out/main.js" ]; then
            echo "✗ Missing out/main.js - compilation incomplete!"
            exit 1
          fi
          echo "✓ out/main.js exists"

          if [ ! -d "out/vs/workbench" ]; then
            echo "✗ Missing out/vs/workbench - compilation incomplete!"
            exit 1
          fi
          echo "✓ out/vs/workbench exists"

          # Check for Linux-specific native binaries that shouldn't be here
          LINUX_NATIVES=$(find node_modules -name "*.node" -exec file {} \; 2>/dev/null | grep -i "ELF.*Linux" | wc -l || echo "0")
          if [ "$LINUX_NATIVES" -gt 0 ]; then
            echo "⚠️  WARNING: Found $LINUX_NATIVES Linux native binaries in node_modules"
            echo "These should have been rebuilt for Windows!"
            find node_modules -name "*.node" -exec file {} \; 2>/dev/null | grep -i "ELF.*Linux" | head -5
          else
            echo "✓ No Linux native binaries found (good)"
          fi

          # Verify all .node files are Windows PE binaries
          TOTAL_NATIVES=$(find node_modules -name "*.node" 2>/dev/null | wc -l || echo "0")
          echo "Found $TOTAL_NATIVES .node files total"

          echo "✓ Build integrity check complete"

      - name: Download Electron binary
        shell: bash
        run: |
          echo "Removing Linux Electron binaries from extracted artifact..."
          rm -rf .build/electron
          echo "Downloading Windows Electron binary..."
          npm exec -- npm-run-all "electron x64"

      - name: Verify Electron download
        shell: bash
        run: |
          echo "Checking for Electron after download..."
          echo "Contents of .build/:"
          ls -la .build/ || echo ".build directory doesn't exist!"
          echo ""
          echo "Contents of .build/electron/ (if exists):"
          ls -la .build/electron/ || echo ".build/electron directory doesn't exist!"
          echo ""
          echo "Looking for Positron.exe:"
          find .build -name "Positron.exe" -o -name "positron.exe" -o -name "Electron.exe" 2>/dev/null || echo "No Positron/Electron executable found"

      - name: Run prelaunch
        shell: bash
        run: |
          echo "Running prelaunch to download bootstrap and builtin extensions..."
          npm run prelaunch
          echo "Prelaunch completed"

          echo "Verifying bootstrap extensions downloaded:"
          ls -la .build/bootstrapExtensions/ 2>/dev/null || echo ".build/bootstrapExtensions/ is empty or missing"

          echo "Verifying builtin extensions downloaded:"
          ls -la .build/builtInExtensions/ 2>/dev/null || echo ".build/builtInExtensions/ is empty or missing"

      - name: Verify Electron after prelaunch
        shell: bash
        run: |
          echo "Checking for Electron after prelaunch..."
          echo "Contents of .build/:"
          ls -la .build/ || echo ".build directory doesn't exist!"
          echo ""
          echo "Contents of .build/electron/:"
          ls -la .build/electron/ || echo ".build/electron directory doesn't exist!"
          echo ""
          if [ -f ".build/electron/Positron.exe" ]; then
            echo "✓ Positron.exe found at .build/electron/Positron.exe"
          else
            echo "✗ Positron.exe NOT found at .build/electron/Positron.exe"
            echo "Searching entire .build directory:"
            find .build -type f -name "*.exe" 2>/dev/null || echo "No .exe files found in .build"
          fi

      - name: Compile E2E Tests
        run: npm --prefix test/e2e run compile

      - name: Cache QA example content
        id: cache-qa-content
        uses: actions/cache@v4
        with:
          path: C:\tmp\qa-example-content-cache
          key: qa-content-${{ hashFiles('.github/workflows/test-e2e-windows-run.yml') }}-v1
          restore-keys: |
            qa-content-

      - name: Clone QA example content
        if: steps.cache-qa-content.outputs.cache-hit != 'true'
        shell: bash
        run: |
          echo "Cache miss - Cloning QA example content"
          rm -rf /c/tmp/qa-example-content-cache || true
          git clone --depth=1 --branch main https://github.com/posit-dev/qa-example-content.git /c/tmp/qa-example-content-cache || true
          if [ -d /c/tmp/qa-example-content-cache ]; then
            (cd /c/tmp/qa-example-content-cache && git rev-parse HEAD > .cached-commit) || true
          fi

      - name: Move QA cache to expected location
        shell: bash
        run: |
          # Tests expect cache at os.tmpdir()/qa-example-content-cache
          TEMP_DIR="$(echo $TEMP | sed 's/\\/\//g')"
          TARGET_DIR="$TEMP_DIR/qa-example-content-cache"

          echo "Moving QA cache to: $TARGET_DIR"
          rm -rf "$TARGET_DIR" || true
          mkdir -p "$(dirname "$TARGET_DIR")"

          if [ -d "/c/tmp/qa-example-content-cache" ]; then
            cp -R /c/tmp/qa-example-content-cache "$TARGET_DIR"
          else
            echo "Warning: QA content cache not found"
            exit 1
          fi

          if [ -f "$TARGET_DIR/.cached-commit" ]; then
            echo "✓ QA cache moved successfully"
          else
            echo "✗ Failed to move QA cache"
            exit 1
          fi

      - name: Restore Playwright browser cache
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        if: ${{ steps.cache-playwright.outputs.cache-hit != 'true' }}
        run: npm run playwright-install

      - name: Setup Python 3.10.10
        uses: actions/setup-python@v6
        with:
          python-version: "3.10.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Cache Python packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install python dependencies
        run: |
          curl https://raw.githubusercontent.com/posit-dev/qa-example-content/main/requirements.txt --output requirements.txt
          uv pip install --system --upgrade pip
          uv pip install --system -r requirements.txt
          uv pip install --system trcli

      - name: Install Python 3.13.0
        uses: actions/setup-python@v6
        with:
          python-version: "3.13.0"

      - name: Install ipykernel for Python 3.13.0
        run: |
          python --version  # Verify it's 3.13.0
          uv pip install --system --upgrade pip
          uv pip install --system ipykernel

      - name: Install rig
        run: |
          choco install rig

      - name: Install R 4.4.0
        run: |
          rig add 4.4.0
          rig default 4.4.0
          rig ls

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\R\cache
            C:\Program Files\R\R-4.4.0\library
          key: ${{ runner.os }}-r-4.4.0-${{ hashFiles('**/DESCRIPTION') }}
          restore-keys: |
            ${{ runner.os }}-r-4.4.0-

      - name: Install R packages for 4.4.0
        run: |
          curl https://raw.githubusercontent.com/posit-dev/qa-example-content/main/DESCRIPTION --output DESCRIPTION
          Rscript -e "install.packages('pak')"
          Rscript -e "pak::local_install_dev_deps(ask = FALSE, upgrade = FALSE)"

      - name: Install R 4.4.2
        run: |
          rig add 4.4.2
          rig ls

      - name: Setup Graphviz
        uses: ts-graphviz/setup-graphviz@v2.0.2

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tinytex: true

      - name: Send Results to GH Summary
        uses: ./.github/actions/gen-report-dir

      - name: Verify Electron before Extensions Tests
        shell: bash
        run: |
          echo "Verifying Electron binary exists before Extensions Tests..."
          if [ -f ".build/electron/Positron.exe" ]; then
            echo "✓ Positron.exe exists at .build/electron/Positron.exe"
            ls -lh .build/electron/Positron.exe
          else
            echo "✗ Positron.exe MISSING before Extensions Tests!"
            echo "This should never happen - something went wrong during setup"
            exit 1
          fi

      - name: Run Extensions Tests
        id: extensions
        continue-on-error: true
        shell: bash
        run: |
          set +e
          mkdir -p extensions-tests-logs
          npm run test-extension -- -l positron-r 2>&1 | tee extensions-tests-logs/runner.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0

      - name: Save Extensions Tests Logs
        if: ${{ always() && steps.extensions.outputs.exit_code != '0' }}
        shell: bash
        run: |
          if [ -d ".build/logs/integration-tests" ]; then
            echo "Uploading VSCode integration test logs"
            mkdir -p extensions-tests-logs
            cp -r .build/logs/integration-tests/* extensions-tests-logs/ || true
          else
            echo "No VSCode logs directory found at .build/logs/integration-tests"
          fi
          exit 0

      - name: Verify Electron after Extensions Tests
        if: ${{ always() }}
        shell: bash
        run: |
          echo "Verifying Electron binary still exists after Extensions Tests..."
          if [ -f ".build/electron/Positron.exe" ]; then
            echo "✓ Positron.exe still exists at .build/electron/Positron.exe"
            ls -lh .build/electron/Positron.exe
          else
            echo "✗ Positron.exe MISSING after Extensions Tests!"
            echo "Contents of .build/:"
            ls -la .build/ || echo ".build directory doesn't exist"
            echo ""
            echo "Contents of .build/electron/:"
            ls -la .build/electron/ || echo ".build/electron directory doesn't exist"
            echo ""
            echo "Searching for any .exe files:"
            find .build -name "*.exe" 2>/dev/null || echo "No .exe files found"
          fi

      - name: Cleanup after Extensions Tests
        if: ${{ always() }}
        shell: bash
        run: |
          echo "Ensuring no Positron processes are still running..."
          # Kill any lingering Positron/Electron processes from Extensions Tests
          taskkill //F //IM Positron.exe //T 2>/dev/null || echo "No Positron.exe to kill"
          taskkill //F //IM electron.exe //T 2>/dev/null || echo "No electron.exe to kill"

          # Wait a moment for processes to fully terminate and release resources
          sleep 3

          echo "✓ Cleanup complete"

      - name: Debug Before Bootstrap Test
        if: ${{ inputs.skip_extension_test != true }}
        shell: bash
        run: |
          echo "========================================="
          echo "DEBUGGING ELECTRON PATH BEFORE BOOTSTRAP TEST"
          echo "========================================="
          echo "Current working directory: $(pwd)"
          echo ""
          echo "Checking .build/electron/Positron.exe:"
          if [ -f ".build/electron/Positron.exe" ]; then
            echo "✓ File EXISTS"
            ls -lh .build/electron/Positron.exe
          else
            echo "✗ File MISSING!"
          fi
          echo ""
          echo "Checking what getDevElectronPath() would resolve to:"
          node -e "
            const path = require('path');
            const fs = require('fs');
            const root = process.cwd();
            const product = JSON.parse(fs.readFileSync(path.join(root, 'product.json'), 'utf-8'));
            const electronPath = path.join(root, '.build', 'electron', product.nameShort + '.exe');
            console.log('Root directory:', root);
            console.log('Expected path:', electronPath);
            console.log('File exists:', fs.existsSync(electronPath));
            console.log('Absolute path:', path.resolve(electronPath));
          "
          echo ""
          echo "Full contents of .build/electron/:"
          ls -la .build/electron/ || echo "Directory doesn't exist"
          echo ""
          echo "========================================="
          echo "CHECKING FOR RUNNING POSITRON PROCESSES"
          echo "========================================="
          echo "Positron.exe processes:"
          tasklist | grep -i "positron\|electron" || echo "No Positron/Electron processes found"
          echo ""
          echo "Checking locked ports (common Electron ports):"
          netstat -ano | grep -E ":5870|:9080|:9229" || echo "No processes on common debug/extension ports"

      - name: Run Bootstrap Extensions Test
        if: ${{ inputs.skip_extension_test != true }}
        id: bootstrap
        shell: bash
        env:
          POSITRON_PY_VER_SEL: 3.10.10
          POSITRON_R_VER_SEL: 4.4.0
          POSITRON_PY_ALT_VER_SEL: 3.13.0
          POSITRON_R_ALT_VER_SEL: 4.4.2
          PWTEST_BLOB_DO_NOT_REMOVE: 1
        run: npx playwright test test/e2e/tests/extensions/bootstrap-extensions.test.ts --project "${{ inputs.project }}" --reporter=null

      - name: Run Main Test Suite (Electron)
        if: always()              # remove this after debugging
        shell: bash
        env:
          POSITRON_PY_VER_SEL: 3.10.10
          POSITRON_R_VER_SEL: 4.4.0
          POSITRON_PY_ALT_VER_SEL: 3.13.0
          POSITRON_R_ALT_VER_SEL: 4.4.2
          PWTEST_BLOB_DO_NOT_REMOVE: 1
          CURRENTS_TAG: ${{ inputs.currents_tags || 'electron/win' }}
          ENABLE_CURRENTS_REPORTER: ${{ inputs.report_currents }}
          CURRENTS_PROJECT_ID: ${{ vars.CURRENTS_PROJECT_ID }}
          CONNECT_API_KEY: ${{ secrets.CONNECT_API_KEY }}
          USE_KEY: true
        run: |
          if [ -z "$PW_TAGS" ]; then
            GREP_ARG=""
          else
            GREP_ARG="--grep \"$PW_TAGS\""
          fi

          if [ "${{ inputs.shards }}" -gt "1" ]; then
            SHARD_ARG="--shard=${{ matrix.shard }}/${{ inputs.shards }}"
          else
            SHARD_ARG=""
          fi

          echo "Final --grep argument: $GREP_ARG"
          echo "Final --shard argument: $SHARD_ARG"

          CMD="npx playwright test --project ${{ inputs.project }} --workers ${{ inputs.workers }} $SHARD_ARG $GREP_ARG --repeat-each ${{ inputs.repeat_each }} --max-failures ${{ inputs.max_failures }}"

          echo "Running: $CMD"

          if [[ "${{ inputs.allow_soft_fail }}" == "true" ]]; then
            eval $CMD || true
          else
            eval $CMD
          fi

      - name: Upload Extensions Test Logs If Failed
        if: ${{ always() && steps.extensions.outputs.exit_code != '0' }}
        uses: actions/upload-artifact@v4
        with:
          name: extensions-tests-logs
          path: extensions-tests-logs/
          if-no-files-found: ignore

      - name: Upload Test Logs
        if: ${{ always() && inputs.upload_logs }}
        uses: actions/upload-artifact@v4
        with:
          name: e2e-win-logs
          path: test-logs
          if-no-files-found: ignore

      - name: Upload inspect-ai JSON Responses
        if: ${{ always() && inputs.project == 'inspect-ai' }}
        uses: actions/upload-artifact@v4
        with:
          name: inspect-ai-responses
          path: test/assistant-inspect-ai/*.json
