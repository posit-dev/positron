name: "Positron: Full Test Suite"

on:
  workflow_dispatch:
  push:
    branches: ['cmead/run-smokes-against-release']

permissions:
  id-token: write
  contents: read

jobs:
  linux:
    name: Tests on Linux
    runs-on: ubuntu-latest-8x
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc

      - name: Compile tests
        run: |
          yarn --cwd test/automation compile
          yarn --cwd test/smoke compile

      - name: Get & install latest release
        id: get_latest_release
        run: |
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/posit-dev/positron-builds/releases")
          latest_tag=$(echo "${response}" | jq -r '.[0].tag_name')
          asset_url=$(echo "${response}" | jq -r '.[0].assets[] | select(.name|match("deb")) | .url')
          filename=$(echo "${response}" | jq -r '.[0].assets[] | select(.name|match("deb")) | .name')
          echo "Latest release: ${latest_tag}"
          echo "Downloading ${filename} from ${asset_url}..."
          curl -L -H "Accept: application/octet-stream" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "${asset_url}" -o "${filename}"
          sudo dpkg -i "${filename}"


