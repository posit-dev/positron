name: 'Nightly: Bootstrap Extensions Check'

# Run builds daily at 2am UTC (10p EST) on weekdays for now, or manually
on:
  schedule:
    - cron: "0 2 * * 1-5"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  packages: read

jobs:
  extensions-linux:
    name: 'extensions-linux'
    timeout-minutes: 60
    runs-on: ubuntu-latest-8x
    container:
      image: ghcr.io/posit-dev/positron-ubuntu24-amd64:64
      options: --user 0:0
      # Static PAT is needed because the bot can't pass a token to the job for security reasons
      credentials:
        username: ${{ secrets.POSITRON_GITHUB_RO_USER }}
        password: ${{ secrets.POSITRON_GITHUB_RO_PAT }}

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      POSITRON_BUILD_NUMBER: 0 # CI skips building releases
    steps:
      - uses: actions/checkout@v5

      - name: Restore caches
        id: restore-caches
        uses: ./.github/actions/restore-build-caches

      - name: Install node dependencies
        if: steps.restore-caches.outputs.cache-npm-hit != 'true'
        uses: nick-fields/retry@v3
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          POSITRON_GITHUB_RO_PAT: ${{ github.token }}
          POSITRON_PARALLEL_INSTALL: '1'
          POSITRON_NPM_CONCURRENCY: '10'
          NPM_CONFIG_AUDIT: 'false'              # Skip security audit during install (speeds up install)
          NPM_CONFIG_FUND: 'false'               # Skip funding messages
          NPM_CONFIG_UPDATE_NOTIFIER: 'false'    # Skip update notifications
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_wait_seconds: 5
          shell: bash
          command: bash scripts/install-npm-parallel.sh

      - name: Compile Positron and Download Electron
        run: npm exec -- npm-run-all --max-old-space-size=8192 -p compile "electron x64"

      - name: Install Playwright browsers
        if: ${{ steps.restore-caches.outputs.cache-playwright-hit != 'true' }}
        run: |
          echo "Cache miss - Installing Playwright browser binaries into $HOME/.cache/ms-playwright"
          npx playwright install --with-deps

      # Downloads Builtin Extensions (needed for integration & e2e testing)
      - name: Prelaunch
        run: npm run prelaunch

      - name: Save caches
        uses: ./.github/actions/save-build-caches
        with:
          cache-npm-hit: ${{ steps.restore-caches.outputs.cache-npm-hit }}
          cache-playwright-hit: ${{ steps.restore-caches.outputs.cache-playwright-hit }}
          cache-electron-hit: ${{ steps.restore-caches.outputs.cache-electron-hit }}
          cache-builtins-hit: ${{ steps.restore-caches.outputs.cache-builtins-hit }}
          extensions-hash: ${{ steps.restore-caches.outputs.extensions-hash }}

      - name: Setup Xvfb
        uses: ./.github/actions/setup-xvfb

      - name: Send Results to GH Summary
        uses: ./.github/actions/gen-report-dir

      - name: Run Playwright Tests (Electron)
        shell: bash
        env:
          POSITRON_PY_VER_SEL: "3.10.12"
          POSITRON_R_VER_SEL: 4.4.0
          POSITRON_PY_ALT_VER_SEL: "3.13.0"
          POSITRON_R_ALT_VER_SEL: 4.4.2
          PWTEST_BLOB_DO_NOT_REMOVE: 1
          EXTENSIONS_FAIL_ON_MISMATCH: true
        run: |
          echo "Running: npx playwright test test/e2e/tests/extensions/bootstrap-extensions.test.ts --project e2e-electron --reporter=null"
          npx playwright test test/e2e/tests/extensions/bootstrap-extensions.test.ts --project e2e-electron --reporter=null

  slack-notify:
    if: failure()
    needs: [extensions-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack
        uses: midleman/slack-workflow-status@v3.1.3
        with:
          gh_repo_token: ${{ secrets.GITHUB_TOKEN }}
          slack_token: ${{ secrets.SLACK_TOKEN_TEST_STATUS }}
          slack_channel: "#positron-test-results"
          notify_on: "failure"
