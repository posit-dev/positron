name: "Test: PR"

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
      - 'prerelease/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  pr-tags:
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.pr-tags.outputs.tags }}
      win_tag_found: ${{ steps.pr-tags.outputs.win_tag_found }}
      web_tag_found: ${{ steps.pr-tags.outputs.web_tag_found }}

    steps:
      - uses: actions/checkout@v4

      - name: Parse Tags from PR Body
        id: pr-tags
        run: bash scripts/pr-tags-parse.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}

  e2e-linux-electron:
    name: e2e
    uses: ./.github/workflows/test-e2e-linux.yml
    needs: pr-tags
    with:
      grep: ${{ needs.pr-tags.outputs.tags }}
      display_name: "electron (linux)"
      currents_tags: "pull-request,electron/linux,${{ needs.pr-tags.outputs.tags }}"
      report_testrail: false
    secrets: inherit

  e2e-windows-electron:
    needs: pr-tags
    if: ${{ needs.pr-tags.outputs.win_tag_found == 'true' }}
    name: e2e
    uses: ./.github/workflows/test-e2e-windows.yml
    with:
      grep: ${{ needs.pr-tags.outputs.tags }}
      display_name: "electron (windows)"
      currents_tags: "pull-request,electron/windows,${{ needs.pr-tags.outputs.tags }}"
      report_testrail: false
    secrets: inherit

  e2e-linux-browser:
    needs: pr-tags
    if: ${{ needs.pr-tags.outputs.web_tag_found == 'true' }}
    name: e2e
    uses: ./.github/workflows/test-e2e-linux.yml
    with:
      grep: ${{ needs.pr-tags.outputs.tags }}
      display_name: "browser (linux)"
      project: "e2e-browser"
      currents_tags: "pull-request,browser/linux,${{ needs.pr-tags.outputs.tags }}"
      report_testrail: false
    secrets: inherit

  unit-tests:
    name: test
    uses: ./.github/workflows/test-unit.yml
    secrets: inherit

  integration-tests:
    name: test
    uses: ./.github/workflows/test-integration.yml
    secrets: inherit

  slack-notify:
    if: always()
    needs: [e2e-linux-electron] #, e2e-windows-electron, e2e-linux-browser]
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        uses: midleman/slack-workflow-status@mi/comment-thread
        with:
          repo_token: ${{ secrets.POSITRON_GITHUB_PAT }}
          # slack_webhook_url: ${{ secrets.SLACK_MARIE_WEBHOOK_URL }}
          slack_token: ${{ secrets.SLACK_TOKEN_TEST_STATUS }}
          notify_on: "always"
          channel: "U07KNKY6S5C"
