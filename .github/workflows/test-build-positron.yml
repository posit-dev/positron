name: "E2E: Build Postiron (Ubuntu)"

on:
  workflow_call:

permissions:
  id-token: write
  contents: read
  packages: read

jobs:
  setup:
    name: build
    timeout-minutes: 120
    runs-on: ubuntu-latest-8x
    container:
      image: ghcr.io/posit-dev/positron-ubuntu24-amd64:56
      options: --user 0:0
      # Static PAT is needed because the bot can't pass a token to the job for security reasons
      credentials:
        username: ${{ secrets.POSITRON_GITHUB_RO_USER }}
        password: ${{ secrets.POSITRON_GITHUB_RO_PAT }}
    services:
      postgres:
        image: ghcr.io/posit-dev/positron-postgres-ubuntu24-amd64:56
        credentials:
          username: ${{ secrets.POSITRON_GITHUB_RO_USER }}
          password: ${{ secrets.POSITRON_GITHUB_RO_PAT }}
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: ${{ secrets.E2E_POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.E2E_POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.E2E_POSTGRES_DB }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      DOCKER_CONFIG: /tmp/.docker # Ensure Docker client doesn't try to read a root-owned config file in the container
      POSITRON_BUILD_NUMBER: 0 # CI skips building releases
      _R_CHECK_FUTURE_FILE_TIMESTAMPS_: false # this check can be flaky in the R pkg tests
      _R_CHECK_CRAN_INCOMING_: false
      _R_CHECK_SYSTEM_CLOCK_: false
      AWS_S3_BUCKET: positron-test-reports
      E2E_POSTGRES_USER: ${{ secrets.E2E_POSTGRES_USER }}
      E2E_POSTGRES_PASSWORD: ${{ secrets.E2E_POSTGRES_PASSWORD }}
      E2E_POSTGRES_DB: ${{ secrets.E2E_POSTGRES_DB }}
      E2E_CONNECT_SERVER: ${{ secrets.E2E_CONNECT_SERVER}}
      E2E_CONNECT_APIKEY: ${{ secrets.E2E_CONNECT_APIKEY}}
      R_LIBS_SITE: /usr/local/lib/R/site-library
      R_LIBS_USER: /usr/local/lib/R/site-library
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      RETICULATE_PYTHON: /root/.venv/bin/python
      HOME: /root

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive

      # - name: Load secret
      #   uses: 1password/load-secrets-action@v3
      #   with:
      #     # Export loaded secrets as environment variables
      #     export-env: true
      #   env:
      #     OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
      #     ANTHROPIC_KEY: "op://Positron/Anthropic/credential"

      - name: Ensure Docker config dir is writable
        run: |
          mkdir -p /tmp/.docker
          chmod 700 /tmp/.docker

      - name: Restore caches
        id: restore-caches
        uses: ./.github/actions/cache-multi-paths

      - name: Attempt 1 - Setup Build and Compile
        id: attempt1
        uses: ./.github/actions/setup-build-env
        continue-on-error: true
        with:
          skip-playwright-if-cached: ${{ steps.restore-caches.outputs.cache-playwright-hit }}
          skip-electron-if-cached: ${{ steps.restore-caches.outputs.cache-electron-hit }}
        env:
          NODE_ENV: ${{ env.NODE_ENV }}

      - name: Attempt 2 - Setup Build and Compile
        if: ${{ steps.attempt1.outcome == 'failure' }}
        id: attempt2
        uses: ./.github/actions/setup-build-env
        continue-on-error: true
        with:
          skip-playwright-if-cached: ${{ steps.restore-caches.outputs.cache-playwright-hit }}
          skip-electron-if-cached: ${{ steps.restore-caches.outputs.cache-electron-hit }}

      - name: Attempt 3 - Setup Build and Compile
        id: attempt3
        if: ${{ steps.attempt2.outcome == 'failure' }}
        uses: ./.github/actions/setup-build-env
        with:
          skip-playwright-if-cached: ${{ steps.restore-caches.outputs.cache-playwright-hit }}
          skip-electron-if-cached: ${{ steps.restore-caches.outputs.cache-electron-hit }}

      - name: Fail if Retries Exhausted
        if: ${{ steps.attempt3.outcome == 'failure'  }}
        run: exit 1

      - name: Move Positron License
        run: |
          mv /positron-license /__w/positron || true
          printf "%s" "${{ secrets.POSITRON_DEV_LICENSE }}" > /__w/positron/positron-license/pdol/target/debug/pdol_rsa || true

      # Preloading ensures the Node.js binary is fully built and ready before
      # any parallel processes start, preventing runtime conflicts
      # - name: Preload Node.js Binary
      #   if: ${{ inputs.project == 'e2e-chromium' }}
      #   run: npm run gulp node


      - name: Create Build Artifact
        run: |
          # Ensure QA example content is bundled so downstream runners that lack network
          # access can still prepare test fixtures. We clone into the workspace path
          # under positron/test/e2e/qa-example-content-cache if it doesn't already exist.
          mkdir -p /__w/positron/test/e2e
          if [ ! -d "/__w/positron/test/e2e/qa-example-content-cache" ]; then
            git clone --depth=1 --branch main https://github.com/posit-dev/qa-example-content.git /__w/positron/test/e2e/qa-example-content-cache || true
          fi
          # Seed cache metadata so the test runner can detect the cached commit
          if [ -d "/__w/positron/test/e2e/qa-example-content-cache" ]; then
            (cd /__w/positron/test/e2e/qa-example-content-cache && git rev-parse HEAD > .cached-commit) || true
          fi

          # Create a tarball of the entire positron workspace. Exclude .git to avoid including repository history.
          # Write the Positron license into the workspace
            echo "Installing Positron license into workspace for artifact inclusion"
            mkdir -p /__w/positron/positron-license/pdol/target/debug
            # Write the secret file. Use printf to avoid trailing newline issues.
            printf "%s" "${{ secrets.POSITRON_DEV_LICENSE }}" > /__w/positron/positron-license/pdol/target/debug/pdol_rsa || true

          mkdir -p /tmp/artifacts
          # Install zstd and pigz if apt is available so we can produce fast zstd archives.
          if command -v apt-get >/dev/null 2>&1; then
            echo "Installing pigz and zstd for faster compression (if not already present)"
            DEBIAN_FRONTEND=noninteractive apt-get update -y || true
            DEBIAN_FRONTEND=noninteractive apt-get install -y pigz zstd || true
          fi

          # Prefer zstd for best compress+decompress speed and smaller output (requires zstd on unpack side).
          # Fall back to pigz (parallel gzip) if zstd is not available, else gzip -1 as a final fallback.
          if command -v zstd >/dev/null 2>&1; then
            echo "Using zstd (multithreaded) for compression"
            # Place options (exclude) before the filenames so tar respects them.
            tar -C /__w --exclude='.git' --use-compress-program='zstd -T0 -3' -cf /tmp/artifacts/positron-build.tar.zst positron || true
          elif command -v pigz >/dev/null 2>&1; then
            echo "zstd not available; using pigz (parallel gzip) for compression"
            tar -C /__w --exclude='.git' --use-compress-program=pigz -cf /tmp/artifacts/positron-build.tar.gz positron || true
          else
            echo "zstd and pigz not available; using gzip -1 for faster compression"
            # Use gzip -1 via a pipe to avoid using the deprecated GZIP env var
            tar -C /__w --exclude='.git' -cf - positron | gzip -1 > /tmp/artifacts/positron-build.tar.gz || true
          fi

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "positron-build"
          path: /tmp/artifacts
          retention-days: 1
