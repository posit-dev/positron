name: "Test: Integration"

# Cache Save Strategy:
# This workflow has a save_cache parameter to prevent race conditions when multiple jobs
# try to save the same cache key simultaneously. Only ONE job per calling workflow should
# set save_cache: true. Examples:
# - test-pull-request.yml: unit-tests saves, integration-tests and e2e do not
# - test-merge.yml: unit-tests saves, setup/integration/e2e do not
# - test-full-suite.yml: setup job saves via test-e2e-ubuntu-build.yml, all others do not

on:
  workflow_call:
    inputs:
      pull_request:
        required: false
        type: boolean
      save_cache:
        required: false
        description: "Whether to save caches after the run (only one job per workflow should save to avoid race conditions)"
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      pull_request:
        description: "Is this a pull request run?"
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  integration-tests:
    name: integration
    runs-on: ubuntu-latest-4x
    timeout-minutes: 60
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      POSITRON_BUILD_NUMBER: 0 # CI skips building releases
      _R_CHECK_FUTURE_FILE_TIMESTAMPS_: false # this check can be flaky in the R pkg tests
      _R_CHECK_CRAN_INCOMING_: false
      _R_CHECK_SYSTEM_CLOCK_: false
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          package-manager-cache: false

      - name: Restore caches
        id: restore-caches
        uses: ./.github/actions/restore-build-caches

      - name: Verify npm cache integrity
        id: verify-npm-cache
        uses: ./.github/actions/verify-npm-cache
        with:
          cache-npm-core-hit: ${{ steps.restore-caches.outputs.cache-npm-core-hit }}

      - name: Debug - Capture file state after cache restore
        if: steps.restore-caches.outputs.cache-npm-core-hit == 'true' && steps.verify-npm-cache.outputs.verification != 'failed'
        run: |
          echo "ðŸ“‹ Capturing file state after cache restore..."

          # Show cache restore outputs
          echo "=== Cache Restore Status ==="
          echo "npm-core hit: ${{ steps.restore-caches.outputs.cache-npm-core-hit }}"
          echo "npm-extensions hit: ${{ steps.restore-caches.outputs.cache-npm-extensions-hit }}"

          # List ALL extension node_modules directories that exist
          echo ""
          echo "=== ALL extension node_modules directories ==="
          find extensions -maxdepth 2 -type d -name "node_modules" | sort || echo "None found"

          # Count how many extension node_modules we found
          echo ""
          echo "=== Count of extension node_modules ==="
          find extensions -maxdepth 2 -type d -name "node_modules" | wc -l

          # Check size of a few key extension node_modules
          echo ""
          echo "=== Size of key extension node_modules ==="
          du -sh extensions/vscode-api-tests/node_modules 2>/dev/null || echo "vscode-api-tests/node_modules: NOT FOUND"
          du -sh extensions/positron-supervisor/node_modules 2>/dev/null || echo "positron-supervisor/node_modules: NOT FOUND"
          du -sh extensions/positron-python/node_modules 2>/dev/null || echo "positron-python/node_modules: NOT FOUND"
          du -sh extensions/positron-r/node_modules 2>/dev/null || echo "positron-r/node_modules: NOT FOUND"

          # Check if node_modules directories are empty or have content
          echo ""
          echo "=== Sample content from vscode-api-tests/node_modules ==="
          ls extensions/vscode-api-tests/node_modules/ 2>/dev/null | head -10 || echo "Directory not found or empty"

          # Check for out/ directories (should NOT exist after cache restore)
          echo ""
          echo "=== out/ directories (should be empty after restore) ==="
          find extensions -maxdepth 2 -type d -name "out" | wc -l

          # Detailed check of vscode-api-tests
          echo ""
          echo "=== extensions/vscode-api-tests directory listing ==="
          ls -la extensions/vscode-api-tests/ || echo "Directory not found"

          # Check for specific test files (source, not compiled)
          echo ""
          echo "=== Looking for runtime.test.ts source ==="
          find extensions/vscode-api-tests/src -name "*runtime.test*" || echo "Not found"

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Install node dependencies
        if: steps.restore-caches.outputs.cache-npm-core-hit != 'true' || steps.restore-caches.outputs.cache-npm-extensions-hit != 'true' || steps.verify-npm-cache.outputs.verification == 'failed'
        uses: nick-fields/retry@v3
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          POSITRON_GITHUB_RO_PAT: ${{ github.token }}
          POSITRON_PARALLEL_INSTALL: '1'
          POSITRON_NPM_CONCURRENCY: '10'
          NPM_CONFIG_AUDIT: 'false'              # Skip security audit during install (speeds up install)
          NPM_CONFIG_FUND: 'false'               # Skip funding messages
          NPM_CONFIG_UPDATE_NOTIFIER: 'false'    # Skip update notifications
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_wait_seconds: 5
          shell: bash
          command: |
            # Echo the if condition for debugging
            echo "Cache npm core hit: ${{ steps.restore-caches.outputs.cache-npm-core-hit }}"
            echo "Cache npm extensions hit: ${{ steps.restore-caches.outputs.cache-npm-extensions-hit }}"
            echo "NPM cache verification: ${{ steps.verify-npm-cache.outputs.verification }}"

            # Install node-gyp (required by some packages)
            npm i --global node-gyp

            # Run parallel npm install
            bash scripts/install-npm-parallel.sh

      - name: Compile Positron and Download Electron
        run: npm exec -- npm-run-all --max-old-space-size=8192 -p compile "electron x64"

      - name: Debug - Capture file state after compilation
        run: |
          echo "ðŸ“‹ Capturing file state after compilation..."

          # Count all out/ directories
          echo "=== Count of extension out/ directories ==="
          find extensions -maxdepth 2 -type d -name "out" | wc -l

          # List all out/ directories
          echo ""
          echo "=== All extension out/ directories ==="
          find extensions -maxdepth 2 -type d -name "out" | sort | head -30 || echo "None found"

          # Check size of key out/ directories
          echo ""
          echo "=== Size of key extension out/ directories ==="
          du -sh extensions/vscode-api-tests/out 2>/dev/null || echo "vscode-api-tests/out: NOT FOUND"
          du -sh extensions/positron-supervisor/out 2>/dev/null || echo "positron-supervisor/out: NOT FOUND"
          du -sh extensions/positron-python/out 2>/dev/null || echo "positron-python/out: NOT FOUND"

          # Check for compiled runtime tests
          echo ""
          echo "=== Looking for compiled runtime.test.js ==="
          find extensions/vscode-api-tests/out -name "*runtime.test*" 2>/dev/null || echo "Not found"

          # Sample content from key out/ directories
          echo ""
          echo "=== Sample content from vscode-api-tests/out ==="
          ls extensions/vscode-api-tests/out/ 2>/dev/null | head -10 || echo "Directory not found"

          echo ""
          echo "=== Sample content from positron-supervisor/out ==="
          ls extensions/positron-supervisor/out/ 2>/dev/null | head -10 || echo "Directory not found"

      - name: Install Playwright browsers and system dependencies
        if: ${{ steps.restore-caches.outputs.cache-playwright-hit != 'true' || steps.restore-caches.outputs.verify-playwright-outcome == 'failure' }}
        run: |
          echo "Installing Playwright browsers (cache-hit: ${{ steps.restore-caches.outputs.cache-playwright-hit }}, verification: ${{ steps.restore-caches.outputs.verify-playwright-outcome }})"
          npx playwright install --with-deps

      - name: Set permissions on SUID sandbox helper
        run: |
          ELECTRON_ROOT=.build/electron
          sudo chown root $ELECTRON_ROOT/chrome-sandbox
          sudo chmod 4755 $ELECTRON_ROOT/chrome-sandbox
          stat $ELECTRON_ROOT/chrome-sandbox

      - name: Configure xvfb Service
        run: |
          sudo cp build/azure-pipelines/linux/xvfb.init /etc/init.d/xvfb
          sudo chmod +x /etc/init.d/xvfb
          sudo update-rc.d xvfb defaults
          sudo service xvfb start

      - name: Ensure Ark binary is present
        run: |
          # Always ensure Ark is downloaded and functional, regardless of cache status
          # This handles both cache hit (postinstall skipped) and cache miss (postinstall may have failed) scenarios
          if [ ! -f "extensions/positron-r/resources/ark/ark" ] || ! extensions/positron-r/resources/ark/ark --version 2>/dev/null; then
            echo "Ark binary missing or not executable, downloading..."
            rm -rf extensions/positron-r/resources/ark
            cd extensions/positron-r && npm run postinstall
          else
            echo "Ark binary already present and functional"
          fi

      # Downloads Builtin Extensions (needed for integration & e2e testing)
      - name: Prelaunch
        run: npm run prelaunch

      - name: Save caches
        if: ${{ inputs.save_cache }}
        uses: ./.github/actions/save-build-caches
        with:
          cache-npm-core-hit: ${{ steps.restore-caches.outputs.cache-npm-core-hit }}
          cache-npm-extensions-hit: ${{ steps.restore-caches.outputs.cache-npm-extensions-hit }}
          cache-playwright-hit: ${{ steps.restore-caches.outputs.cache-playwright-hit }}
          cache-electron-hit: ${{ steps.restore-caches.outputs.cache-electron-hit }}
          cache-builtins-hit: ${{ steps.restore-caches.outputs.cache-builtins-hit }}
          cache-ark-hit: ${{ steps.restore-caches.outputs.cache-ark-hit }}
          cache-kallichore-hit: ${{ steps.restore-caches.outputs.cache-kallichore-hit }}
          extensions-hash: ${{ steps.restore-caches.outputs.extensions-hash }}
          package-locks-hash: ${{ steps.restore-caches.outputs.package-locks-hash }}

      - name: Install Positron License
        uses: ./.github/actions/install-license
        with:
          github-token: ${{ secrets.POSITRON_GITHUB_RO_PAT }}
          license-key: ${{ secrets.POSITRON_DEV_LICENSE }}

      # one integration test needs this: Connections pane works for R
      - name: Download R DESCRIPTION file
        id: download-r-desc
        run: |
          curl -s https://raw.githubusercontent.com/posit-dev/qa-example-content/main/DESCRIPTION --output DESCRIPTION
          HASH=$(sha256sum DESCRIPTION | awk '{print $1}')
          echo "description-hash=$HASH" >> $GITHUB_OUTPUT
          echo "R DESCRIPTION hash: $HASH"

      - name: Restore R installation and packages cache
        id: cache-r
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.local/share/rig
            ~/.cache/R
            /usr/local/lib/R/site-library
            /opt/R
          key: ${{ runner.os }}-r-4.4.0-${{ steps.download-r-desc.outputs.description-hash }}
          restore-keys: |
            ${{ runner.os }}-r-4.4.0-

      - name: Setup R
        if: ${{ steps.cache-r.outputs.cache-hit != 'true' }}
        uses: ./.github/actions/install-r
        with:
          version: "4.4.0"

      # Note: R cache is NOT saved here to avoid race conditions with unit tests
      # Unit tests save the R cache since both workflows often run in parallel
      # (see test-pull-request.yml and test-merge.yml)

      - name: Compile Integration Tests
        run: npm run --prefix test/integration/browser compile

      - name: Run Integration Tests (Electron)
        id: electron-integration-tests
        run: |
          if [ "${{ inputs.pull_request }}" = "true" ]; then
            DISPLAY=:10 ./scripts/test-integration-pr.sh
          else
            DISPLAY=:10 ./scripts/test-integration.sh
          fi

      - name: Run Integration Tests (Remote)
        if: ${{ job.status != 'cancelled' && (success() || failure()) }}
        id: electron-remote-integration-tests
        run: DISPLAY=:10 ./scripts/test-remote-integration.sh

      - name: Run Integration Tests (Browser, Chromium)
        if: ${{ job.status != 'cancelled' && (success() || failure()) }}
        id: browser-integration-tests
        run: DISPLAY=:10 ./scripts/test-web-integration.sh --browser chromium
