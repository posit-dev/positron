name: "Test: Unit"

# Cache Save Strategy:
# This workflow has a save_cache parameter to prevent race conditions when multiple jobs
# try to save the same cache key simultaneously. Only ONE job per calling workflow should
# set save_cache: true. Examples:
# - test-pull-request.yml: unit-tests saves, integration-tests and e2e do not
# - test-merge.yml: unit-tests saves, setup/integration/e2e do not
# - test-full-suite.yml: setup job saves via test-e2e-ubuntu-build.yml, all others do not

on:
  workflow_call:
    inputs:
      save_cache:
        required: false
        description: "Whether to save caches after the run (only one job per workflow should save to avoid race conditions)"
        type: boolean
        default: false
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  unit-tests:
    name: unit
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      POSITRON_BUILD_NUMBER: 0 # CI skips building releases
      _R_CHECK_FUTURE_FILE_TIMESTAMPS_: false # this check can be flaky in the R pkg tests
      _R_CHECK_CRAN_INCOMING_: false
      _R_CHECK_SYSTEM_CLOCK_: false
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          package-manager-cache: false

      - name: Restore caches
        id: restore-caches
        uses: ./.github/actions/restore-build-caches

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Install node dependencies
        if: steps.restore-caches.outputs.cache-npm-core-hit != 'true' || steps.restore-caches.outputs.cache-npm-extensions-hit != 'true'
        uses: nick-fields/retry@v3
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          POSITRON_GITHUB_RO_PAT: ${{ github.token }}
          POSITRON_PARALLEL_INSTALL: '1'
          POSITRON_NPM_CONCURRENCY: '10'
          NPM_CONFIG_AUDIT: 'false'              # Skip security audit during install (speeds up install)
          NPM_CONFIG_FUND: 'false'               # Skip funding messages
          NPM_CONFIG_UPDATE_NOTIFIER: 'false'    # Skip update notifications
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_wait_seconds: 5
          shell: bash
          command: |
            # Install node-gyp (required by some packages)
            npm i --global node-gyp

            # Run parallel npm install
            bash scripts/install-npm-parallel.sh

      - name: Compile Positron and Download Electron
        run: npm exec -- npm-run-all --max-old-space-size=8192 -p compile "electron x64"

      - name: Install Playwright browsers and system dependencies
        if: ${{ steps.restore-caches.outputs.cache-playwright-hit != 'true' }}
        run: npx playwright install --with-deps

      - name: Ensure Ark binary is present
        run: |
          # Always ensure Ark is downloaded and functional, regardless of cache status
          # This handles both cache hit (postinstall skipped) and cache miss (postinstall may have failed) scenarios
          if [ ! -f "extensions/positron-r/resources/ark/ark" ] || ! extensions/positron-r/resources/ark/ark --version 2>/dev/null; then
            echo "Ark binary missing or not executable, downloading..."
            rm -rf extensions/positron-r/resources/ark
            cd extensions/positron-r && npm run postinstall
          else
            echo "Ark binary already present and functional"
          fi

      # Downloads Builtin Extensions (needed for integration & e2e testing)
      - name: Prelaunch
        run: npm run prelaunch

      - name: Save caches
        if: ${{ inputs.save_cache }}
        uses: ./.github/actions/save-build-caches
        with:
          cache-npm-core-hit: ${{ steps.restore-caches.outputs.cache-npm-core-hit }}
          cache-npm-extensions-hit: ${{ steps.restore-caches.outputs.cache-npm-extensions-hit }}
          cache-playwright-hit: ${{ steps.restore-caches.outputs.cache-playwright-hit }}
          cache-electron-hit: ${{ steps.restore-caches.outputs.cache-electron-hit }}
          cache-builtins-hit: ${{ steps.restore-caches.outputs.cache-builtins-hit }}
          extensions-hash: ${{ steps.restore-caches.outputs.extensions-hash }}
          package-locks-hash: ${{ steps.restore-caches.outputs.package-locks-hash }}

      - name: Set permissions on SUID sandbox helper
        run: |
          ELECTRON_ROOT=.build/electron
          sudo chown root $ELECTRON_ROOT/chrome-sandbox
          sudo chmod 4755 $ELECTRON_ROOT/chrome-sandbox
          stat $ELECTRON_ROOT/chrome-sandbox

      - name: Configure xvfb Service
        run: |
          sudo cp build/azure-pipelines/linux/xvfb.init /etc/init.d/xvfb
          sudo chmod +x /etc/init.d/xvfb
          sudo update-rc.d xvfb defaults
          sudo service xvfb start

      - name: Install Positron License
        uses: ./.github/actions/install-license
        with:
          github-token: ${{ secrets.POSITRON_GITHUB_RO_PAT }}
          license-key: ${{ secrets.POSITRON_DEV_LICENSE }}

      # one unit test needs this: Can list tables and fields from R connections
      - name: Download R DESCRIPTION file
        id: download-r-desc
        run: |
          curl -s https://raw.githubusercontent.com/posit-dev/qa-example-content/main/DESCRIPTION --output DESCRIPTION
          HASH=$(sha256sum DESCRIPTION | awk '{print $1}')
          echo "description-hash=$HASH" >> $GITHUB_OUTPUT
          echo "R DESCRIPTION hash: $HASH"

      - name: Restore R installation and packages cache
        id: cache-r
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.local/share/rig
            ~/.cache/R
            /usr/local/lib/R/site-library
            /opt/R
          key: ${{ runner.os }}-r-4.4.0-${{ steps.download-r-desc.outputs.description-hash }}
          restore-keys: |
            ${{ runner.os }}-r-4.4.0-

      - name: Setup R
        if: ${{ steps.cache-r.outputs.cache-hit != 'true' }}
        uses: ./.github/actions/install-r
        with:
          version: "4.4.0"

      # Note: R cache is saved by unit tests (not integration tests) to avoid race conditions
      # when both workflows run in parallel (see test-pull-request.yml and test-merge.yml)
      - name: Save R installation and packages cache
        if: ${{ steps.cache-r.outputs.cache-hit != 'true' }}
        continue-on-error: true
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.local/share/rig
            ~/.cache/R
            /usr/local/lib/R/site-library
            /opt/R
          key: ${{ runner.os }}-r-4.4.0-${{ steps.download-r-desc.outputs.description-hash }}

      - name: Run Unit Tests (Electron)
        id: electron-unit-tests
        run: DISPLAY=:10 ./scripts/test.sh

      - name: Run Unit Tests (node.js)
        id: nodejs-unit-tests
        run: npm run test-node

      - name: Install Unit Test Dependencies
        uses: ./.github/actions/setup-unit-test-env

      - name: Run Unit Tests (Browser, Chromium)
        id: browser-unit-tests
        run: DISPLAY=:10 npm run test-browser-no-install -- --browser chromium
