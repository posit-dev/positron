name: "Test: Full Suite"

on:
  workflow_dispatch:
    inputs:
      run_e2e_linux:
        description: "E2E Tests / Electron (Ubuntu)"
        required: false
        default: true
        type: boolean
      run_e2e_rhel:
        description: "E2E Tests / Electron (RHEL)"
        required: false
        default: false
        type: boolean
      run_e2e_suse:
        description: "E2E Tests / Electron (SUSE)"
        required: false
        default: false
        type: boolean
      run_e2e_debian:
        description: "E2E Tests / Electron (Debian)"
        required: false
        default: false
        type: boolean
      run_e2e_windows:
        description: "E2E Tests / Electron (Windows)"
        required: false
        default: true
        type: boolean
      run_e2e_browser:
        description: "E2E Tests / Chromium (Ubuntu)"
        required: false
        default: true
        type: boolean
      run_e2e_browser_rhel:
        description: "E2E Tests / Chromium (RHEL)"
        required: false
        default: false
        type: boolean
      run_e2e_browser_suse:
        description: "E2E Tests / Chromium (SUSE)"
        required: false
        default: false
        type: boolean
      run_e2e_browser_debian:
        description: "E2E Tests / Chromium (Debian)"
        required: false
        default: false
        type: boolean
      run_unit_tests:
        description: "Unit Tests"
        required: false
        default: false
        type: boolean
      run_integration_tests:
        description: "Integration Tests"
        required: false
        default: false
        type: boolean
      commit:
        description: "Commit SHA to test"
        required: false
        default: "latest"
        type: string
      notify_on:
        description: "Slack notification on:"
        required: false
        default: "failure"
        type: choice
        options:
          - failure
          - always
          - never
      enable_diagnostic_logging:
        description: "Enable diagnostic logging"
        required: false
        default: false
        type: boolean

jobs:
  validate-commit:
    name: validate-commit
    if: ${{ inputs.commit != 'latest' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate commit exists
        run: |
          echo "Validating commit: ${{ inputs.commit }}"
          if git cat-file -t "${{ inputs.commit }}" >/dev/null 2>&1; then
            echo "✓ Commit ${{ inputs.commit }} exists"
            git log -1 --format="  Subject: %s%n  Author: %an%n  Date: %ad" "${{ inputs.commit }}"
          else
            echo "✗ Commit ${{ inputs.commit }} does not exist in this repository"
            echo "  Make sure you're using a full SHA and the commit has been pushed"
            exit 1
          fi

  setup:
    name: setup
    needs: [validate-commit]
    if: ${{ !failure() && !cancelled() && (inputs.run_e2e_linux || inputs.run_e2e_browser) }}
    uses: ./.github/workflows/test-e2e-ubuntu-build.yml
    secrets: inherit
    with:
      commit: ${{ inputs.commit != 'latest' && inputs.commit || '' }}
      skip_cache: ${{ inputs.commit != 'latest' }}

  e2e-electron:
    name: e2e
    needs: [setup]
    if: ${{ !failure() && !cancelled() && (github.event_name == 'schedule' || inputs.run_e2e_linux) }}
    uses: ./.github/workflows/test-e2e-ubuntu-run.yml
    secrets: inherit
    with:
      grep: ""
      project: "e2e-electron"
      display_name: "electron"
      currents_tags: ${{ github.event_name == 'schedule' && 'nightly,electron/ubuntu' || 'electron/ubuntu' }}
      report_currents: false
      install_undetectable_interpreters: true
      install_license: false
      allow_soft_fail: false
      upload_logs: false
      shards: 4
      matrix: '{"shard":[1,2,3,4]}'
      max_failures: 3  # 10 max failures / 4 shards = 2.5, rounded up to 3
      enable_diagnostic_logging: ${{ inputs.enable_diagnostic_logging }}

  e2e-windows:
    name: e2e
    needs: [validate-commit]
    if: ${{ !failure() && !cancelled() && (github.event_name == 'schedule' || inputs.run_e2e_windows) }}
    uses: ./.github/workflows/test-e2e-windows-run.yml
    secrets: inherit
    with:
      commit: ${{ inputs.commit != 'latest' && inputs.commit || '' }}
      skip_cache: ${{ inputs.commit != 'latest' }}
      grep: ""
      project: "e2e-windows"
      display_name: "windows"
      currents_tags: ${{ github.event_name == 'schedule' && 'nightly,electron/win' || 'electron/win' }}
      report_currents: false
      allow_soft_fail: false
      upload_logs: false
      shards: 4
      matrix: '{"shard":[1,2,3,4]}'
      max_failures: 3  # 10 max failures / 4 shards = 2.5, rounded up to 3
      enable_diagnostic_logging: ${{ inputs.enable_diagnostic_logging }}

  e2e-chromium:
    name: e2e
    needs: [setup]
    if: ${{ !failure() && !cancelled() && (github.event_name == 'schedule' || inputs.run_e2e_browser) }}
    uses: ./.github/workflows/test-e2e-ubuntu-run.yml
    secrets: inherit
    with:
      grep: ""
      project: "e2e-chromium"
      display_name: "chromium"
      currents_tags: ${{ github.event_name == 'schedule' && 'nightly,chromium/ubuntu' || 'chromium/ubuntu' }}
      report_currents: false
      install_undetectable_interpreters: true
      install_license: true
      allow_soft_fail: false
      upload_logs: false
      shards: 4
      matrix: '{"shard":[1,2,3,4]}'
      max_failures: 3  # 10 max failures / 4 shards = 2.5, rounded up to 3
      enable_diagnostic_logging: ${{ inputs.enable_diagnostic_logging }}

  e2e-rhel:
    name: e2e
    needs: [validate-commit]
    if: ${{ !failure() && !cancelled() && (github.event_name == 'schedule' || inputs.run_e2e_rhel) }}
    uses: ./.github/workflows/test-e2e-rhel.yml
    secrets: inherit
    with:
      commit: ${{ inputs.commit != 'latest' && inputs.commit || '' }}
      skip_cache: ${{ inputs.commit != 'latest' }}
      grep: ""
      project: "e2e-electron"
      display_name: "electron (rhel)"
      currents_tags: ${{ github.event_name == 'schedule' && 'nightly,electron/rhel' || 'electron/rhel' }}
      report_currents: false
      install_undetectable_interpreters: true
      install_license: false
      allow_soft_fail: false
      enable_diagnostic_logging: ${{ inputs.enable_diagnostic_logging }}

  e2e-chromium-rhel:
    name: e2e
    needs: [validate-commit]
    if: ${{ !failure() && !cancelled() && (github.event_name == 'schedule' || inputs.run_e2e_browser_rhel) }}
    uses: ./.github/workflows/test-e2e-rhel.yml
    secrets: inherit
    with:
      commit: ${{ inputs.commit != 'latest' && inputs.commit || '' }}
      skip_cache: ${{ inputs.commit != 'latest' }}
      grep: ""
      project: "e2e-chromium"
      display_name: "chromium (rhel)"
      currents_tags: ${{ github.event_name == 'schedule' && 'nightly,chromium/rhel' || 'chromium/rhel' }}
      report_currents: false
      install_undetectable_interpreters: true
      install_license: true
      allow_soft_fail: false
      enable_diagnostic_logging: ${{ inputs.enable_diagnostic_logging }}

  e2e-suse:
    name: e2e
    needs: [validate-commit]
    if: ${{ !failure() && !cancelled() && (github.event_name == 'schedule' || inputs.run_e2e_suse) }}
    uses: ./.github/workflows/test-e2e-suse.yml
    secrets: inherit
    with:
      commit: ${{ inputs.commit != 'latest' && inputs.commit || '' }}
      skip_cache: ${{ inputs.commit != 'latest' }}
      grep: ""
      project: "e2e-electron"
      display_name: "electron (suse)"
      currents_tags: ${{ github.event_name == 'schedule' && 'nightly,electron/suse' || 'electron/suse' }}
      report_currents: false
      install_undetectable_interpreters: true
      install_license: false
      allow_soft_fail: false
      enable_diagnostic_logging: ${{ inputs.enable_diagnostic_logging }}

  e2e-chromium-suse:
    name: e2e
    needs: [validate-commit]
    if: ${{ !failure() && !cancelled() && (github.event_name == 'schedule' || inputs.run_e2e_browser_suse) }}
    uses: ./.github/workflows/test-e2e-suse.yml
    secrets: inherit
    with:
      commit: ${{ inputs.commit != 'latest' && inputs.commit || '' }}
      skip_cache: ${{ inputs.commit != 'latest' }}
      grep: ""
      project: "e2e-chromium"
      display_name: "chromium (suse)"
      currents_tags: ${{ github.event_name == 'schedule' && 'nightly,chromium/suse' || 'chromium/suse' }}
      report_currents: false
      install_undetectable_interpreters: true
      install_license: true
      allow_soft_fail: false
      enable_diagnostic_logging: ${{ inputs.enable_diagnostic_logging }}

  e2e-debian:
    name: e2e
    needs: [validate-commit]
    if: ${{ !failure() && !cancelled() && (github.event_name == 'schedule' || inputs.run_e2e_debian) }}
    uses: ./.github/workflows/test-e2e-debian.yml
    secrets: inherit
    with:
      commit: ${{ inputs.commit != 'latest' && inputs.commit || '' }}
      skip_cache: ${{ inputs.commit != 'latest' }}
      grep: ""
      project: "e2e-electron"
      display_name: "electron (debian)"
      currents_tags: ${{ github.event_name == 'schedule' && 'nightly,electron/debian' || 'electron/debian' }}
      report_currents: false
      install_undetectable_interpreters: true
      install_license: false
      allow_soft_fail: false
      enable_diagnostic_logging: ${{ inputs.enable_diagnostic_logging }}

  e2e-chromium-debian:
    name: e2e
    needs: [validate-commit]
    if: ${{ !failure() && !cancelled() && (github.event_name == 'schedule' || inputs.run_e2e_browser_debian) }}
    uses: ./.github/workflows/test-e2e-debian.yml
    secrets: inherit
    with:
      commit: ${{ inputs.commit != 'latest' && inputs.commit || '' }}
      skip_cache: ${{ inputs.commit != 'latest' }}
      grep: ""
      project: "e2e-chromium"
      display_name: "chromium (debian)"
      currents_tags: ${{ github.event_name == 'schedule' && 'nightly,chromium/debian' || 'chromium/debian' }}
      report_currents: false
      install_undetectable_interpreters: true
      install_license: true
      allow_soft_fail: false
      enable_diagnostic_logging: ${{ inputs.enable_diagnostic_logging }}

  unit-tests:
    name: test
    needs: [validate-commit]
    if: ${{ !failure() && !cancelled() && (github.event_name == 'schedule' || inputs.run_unit_tests) }}
    uses: ./.github/workflows/test-unit.yml
    secrets: inherit
    with:
      commit: ${{ inputs.commit != 'latest' && inputs.commit || '' }}

  integration-tests:
    name: test
    needs: [validate-commit]
    if: ${{ !failure() && !cancelled() && (github.event_name == 'schedule' || inputs.run_integration_tests) }}
    uses: ./.github/workflows/test-integration.yml
    secrets: inherit
    with:
      commit: ${{ inputs.commit != 'latest' && inputs.commit || '' }}
      pull_request: false

  slack-notify:
    if: always()
    needs:
      [validate-commit, e2e-electron, e2e-windows, e2e-chromium, e2e-rhel, e2e-chromium-rhel, e2e-suse, e2e-chromium-suse, e2e-debian, e2e-chromium-debian, unit-tests, integration-tests]
    runs-on: ubuntu-latest
    env:
      notify_on: ${{ github.event_name == 'schedule' && 'always' || inputs.notify_on || 'failure' }}
    steps:
      - run: |
          echo "Will notify on: ${{ env.notify_on }}"
      - name: Notify Slack
        uses: midleman/slack-workflow-status@v3.1.3
        with:
          gh_repo_token: ${{ secrets.GITHUB_TOKEN }}
          slack_token: ${{ secrets.SLACK_TOKEN_TEST_STATUS }}
          slack_channel: "#positron-test-results"
          filter_jobs: "(e2e / ([^0-9]*)|unit|integration)$"
          include_job_durations: false
          notify_on: ${{ env.notify_on }}
