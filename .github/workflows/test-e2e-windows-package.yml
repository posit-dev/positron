name: "E2E: Package Positron (Windows)"

on:
  workflow_call:
    secrets:
      OP_SERVICE_ACCOUNT_TOKEN:
        required: true
      E2E_CONNECT_SERVER:
        required: false
      E2E_CONNECT_APIKEY:
        required: false
      DATABRICKS_WORKSPACE:
        required: false
      DATABRICKS_PAT:
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  package-windows:
    name: package-win
    timeout-minutes: 50
    runs-on:
      labels: [windows-latest-8x]
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      POSITRON_BUILD_NUMBER: 0
      E2E_CONNECT_SERVER: ${{ secrets.E2E_CONNECT_SERVER }}
      E2E_CONNECT_APIKEY: ${{ secrets.E2E_CONNECT_APIKEY }}
      DATABRICKS_WORKSPACE: ${{ secrets.DATABRICKS_WORKSPACE }}
      DATABRICKS_PAT: ${{ secrets.DATABRICKS_PAT }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Load secret
        uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          ANTHROPIC_KEY: "op://Positron/Anthropic/credential"
          OPENAI_KEY: "op://Positron/OpenAI/credential"

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc

      - name: Download Linux build artifact
        uses: actions/download-artifact@v4
        with:
          name: "positron-linux-build"
          path: C:\tmp\artifacts

      - name: Install zstd
        shell: bash
        run: |
          if ! command -v zstd >/dev/null 2>&1; then
            choco install zstandard -y
          fi

      - name: Extract Linux build
        shell: bash
        run: |
          cd C:/tmp/artifacts
          echo "Extracting Linux build..."
          # Note: tar may warn about Linux symlinks it can't create on Windows (especially in node_modules/.bin)
          # These warnings are expected and non-fatal - we just need the regular files and executables
          zstd -d -c positron-linux-build.tar.zst | tar -xf - -C /c/a/positron/positron/ || true
          echo "✓ Extracted (symlink warnings are expected and safe to ignore)"

      - name: Verify extracted files
        shell: bash
        run: |
          echo "Checking compiled output..."
          ls -lh out/ | head -5
          echo ""
          echo "Checking node_modules..."
          ls node_modules/ | head -10
          echo "✓ Files extracted successfully"

      - name: Install Windows dependencies
        shell: bash
        env:
          npm_config_arch: x64
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          NPM_CONFIG_AUDIT: 'false'
          NPM_CONFIG_FUND: 'false'
        run: |
          echo "========================================="
          echo "INSTALLING WINDOWS DEPENDENCIES"
          echo "========================================="
          echo "The Linux build contains compiled TypeScript and most dependencies,"
          echo "but we need to reinstall to get Windows-specific native modules and bin links."
          echo ""

          # Clean node_modules to avoid conflicts with Linux binaries
          rm -rf node_modules build/node_modules test/e2e/node_modules

          # Install dependencies for Windows
          npm --prefix build ci --no-audit --no-fund
          npm ci --no-audit --no-fund & \
          npm --prefix test/e2e ci --no-audit --no-fund & \
          wait

          echo "✓ Windows dependencies installed"

      - name: Validate native modules loaded
        shell: bash
        run: |
          echo "Validating native modules..."

          # Test that node-pty works (critical for terminals)
          node -e "try { require('node-pty'); console.log('✓ node-pty OK'); } catch(e) { console.error('✗ node-pty FAILED:', e.message); process.exit(1); }"

          # Test native-keymap
          node -e "try { require('native-keymap'); console.log('✓ native-keymap OK'); } catch(e) { console.error('✗ native-keymap FAILED:', e.message); process.exit(1); }"

          echo "✓ Native modules validated"

      - name: Download Electron binary
        shell: bash
        run: |
          echo "Removing Linux Electron binaries from extracted artifact..."
          rm -rf .build/electron
          echo "Downloading Windows Electron binary..."
          npm exec -- npm-run-all "electron x64"

      - name: Run prelaunch
        shell: bash
        run: npm run prelaunch

      - name: Compile E2E Tests
        run: npm --prefix test/e2e run compile

      - name: Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        if: ${{ steps.cache-playwright.outputs.cache-hit != 'true' }}
        run: npm run playwright-install

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Cache Python packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install python dependencies
        run: |
          curl https://raw.githubusercontent.com/posit-dev/qa-example-content/main/requirements.txt --output requirements.txt
          uv pip install --system --upgrade pip
          uv pip install --system -r requirements.txt
          uv pip install --system trcli

      - name: Install Python 3.13.0
        uses: actions/setup-python@v6
        with:
          python-version: "3.13.0"

      - name: Install ipykernel for Python 3.13.0
        run: |
          python --version
          uv pip install --system --upgrade pip
          uv pip install --system ipykernel

      - name: Install rig
        run: choco install rig

      - name: Install R 4.4.0
        run: |
          rig add 4.4.0
          rig default 4.4.0
          rig ls

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\R\cache
            C:\Program Files\R\R-4.4.0\library
          key: ${{ runner.os }}-r-4.4.0-${{ hashFiles('**/DESCRIPTION') }}
          restore-keys: |
            ${{ runner.os }}-r-4.4.0-

      - name: Install R packages for 4.4.0
        run: |
          curl https://raw.githubusercontent.com/posit-dev/qa-example-content/main/DESCRIPTION --output DESCRIPTION
          Rscript -e "install.packages('pak')"
          Rscript -e "pak::local_install_dev_deps(ask = FALSE, upgrade = FALSE)"

      - name: Install R 4.4.2
        run: |
          rig add 4.4.2
          rig ls

      - name: Setup Graphviz
        uses: ts-graphviz/setup-graphviz@v2.0.2

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tinytex: true

      - name: Cache QA example content
        id: cache-qa-content
        uses: actions/cache@v4
        with:
          path: C:\tmp\qa-example-content-cache
          key: qa-content-${{ hashFiles('.github/workflows/test-e2e-windows-package.yml') }}-v1
          restore-keys: |
            qa-content-

      - name: Clone QA example content
        if: steps.cache-qa-content.outputs.cache-hit != 'true'
        shell: bash
        run: |
          echo "Cache miss - Cloning QA example content"
          rm -rf /c/tmp/qa-example-content-cache || true
          git clone --depth=1 --branch main https://github.com/posit-dev/qa-example-content.git /c/tmp/qa-example-content-cache || true
          if [ -d /c/tmp/qa-example-content-cache ]; then
            (cd /c/tmp/qa-example-content-cache && git rev-parse HEAD > .cached-commit) || true
          fi

      - name: Create Build Artifact
        shell: bash
        run: |
          mkdir -p test/e2e
          if [ -d "/c/tmp/qa-example-content-cache" ]; then
            echo "Copying cached QA content to workspace"
            cp -R /c/tmp/qa-example-content-cache test/e2e/qa-example-content-cache || true
          else
            echo "Warning: QA content cache not found"
          fi

          mkdir -p /c/tmp/artifacts

          echo "Creating compressed archive with zstd"
          tar --exclude='.git' \
              --exclude='.npm-cache' \
              --exclude='.pip-cache' \
              --exclude='node_modules/.cache' \
              --exclude='node_modules/.vite' \
              --exclude='.build/logs' \
              --exclude='*.log' \
              --exclude='.eslintcache' \
              --exclude='*.tsbuildinfo' \
              --exclude='.nyc_output' \
              --exclude='coverage' \
              -cf - . | zstd -1 -T4 > /c/tmp/artifacts/positron-build.tar.zst

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "positron-build-windows-hybrid"
          path: C:\tmp\artifacts
          retention-days: 1
          compression-level: 0
