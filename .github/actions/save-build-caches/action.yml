name: "Save Build Caches"
description: "Saves caches for npm dependencies and built-in extensions. Only saves caches that were restored but missed (cache-*-hit == 'false')."

# IMPORTANT: Cache paths must be kept in sync across 4 files:
# - .github/actions/restore-build-caches/action.yml (Linux)
# - .github/actions/save-build-caches/action.yml (this file - Linux)
# - .github/actions/restore-build-caches-windows/action.yml (Windows)
# - .github/actions/save-build-caches-windows/action.yml (Windows)
#
# When adding/modifying cache paths, update ALL 4 files to maintain restore/save parity.

inputs:
  distro:
    description: "Linux distribution identifier for cache key (default: ubuntu). Use 'rhel' for RHEL/Rocky Linux."
    required: false
    default: 'ubuntu'
  cache-npm-core-hit:
    description: "Whether npm core cache was hit during restore (from restore-build-caches output). If 'false', will save. If 'true' or empty, will skip."
    required: false
    default: ''
  cache-npm-extensions-hit:
    description: "Whether npm extensions cache was hit during restore (from restore-build-caches output). If 'false', will save. If 'true' or empty, will skip."
    required: false
    default: ''
  cache-builtins-hit:
    description: "Whether builtins cache was hit during restore (from restore-build-caches output). If 'false', will save. If 'true' or empty, will skip."
    required: false
    default: ''
  cache-ark-hit:
    description: "Whether Ark binary cache was hit during restore (from restore-build-caches output). If 'false', will save. If 'true' or empty, will skip."
    required: false
    default: ''
  cache-kallichore-hit:
    description: "Whether Kallichore binary cache was hit during restore (from restore-build-caches output). If 'false', will save. If 'true' or empty, will skip."
    required: false
    default: ''
  extensions-hash:
    description: "Extensions hash from restore step (required only if saving npm extensions cache)"
    required: false
    default: ''
  package-locks-hash:
    description: "Package-locks hash from restore step (required only if saving npm core cache)"
    required: false
    default: ''

runs:
  using: "composite"
  steps:
    - name: Validate distro input
      shell: bash
      run: |
        if [[ "${{ runner.os }}" != "Linux" ]]; then
          echo "Error: save-build-caches action is for Linux only. Use save-build-caches-windows for Windows." >&2
          exit 1
        fi

    - name: Save npm core dependencies cache
      if: ${{ inputs.cache-npm-core-hit == 'false' }}
      continue-on-error: true
      uses: actions/cache/save@v4
      with:
        path: |
          .npm-cache
          node_modules
          build/node_modules
          remote/node_modules
          remote/web/node_modules
          remote/reh-web/node_modules
          test/integration/browser/node_modules
          test/monaco/node_modules
          test/mcp/node_modules
        # Package-locks hash comes from restore step (DRY - single source of truth)
        # Note: test/e2e/node_modules excluded - not in postinstall dirs.js, installed separately
        # IMPORTANT: If bumping npm-core-v4 -> npm-core-v5, also update restore-build-caches/action.yml
        key: npm-core-v4-${{ runner.os }}-${{ inputs.distro }}-${{ inputs.package-locks-hash }}

    - name: Save npm extensions cache
      if: ${{ inputs.cache-npm-extensions-hit == 'false' }}
      continue-on-error: true
      uses: actions/cache/save@v4
      with:
        path: |
          extensions/**/node_modules
          .vscode/**/node_modules
          extensions/positron-assistant/resources
          extensions/positron-python/python-env-tools
          extensions/positron-python/python_files
        # Extensions hash comes from restore step (DRY - single source of truth)
        # Cache includes node_modules AND postinstall artifacts (binaries, Python libs, vendored packages)
        # Does NOT cache compiled outputs (out/) - extensions are recompiled during the "Compile Positron" step
        # IMPORTANT: If bumping npm-extensions-v6 -> npm-extensions-v7, also update restore-build-caches/action.yml
        key: npm-extensions-v6-${{ runner.os }}-${{ inputs.distro }}-${{ inputs.extensions-hash }}

    - name: Save built-in extensions cache
      if: ${{ inputs.cache-builtins-hit == 'false' }}
      continue-on-error: true
      uses: actions/cache/save@v4
      with:
        path: |
          .build/builtInExtensions
        # IMPORTANT: If bumping builtins -> builtins-v2, also update restore-build-caches/action.yml
        key: builtins-${{ runner.os }}-${{ hashFiles('product.json') }}

    - name: Verify Ark binary before saving
      if: ${{ inputs.cache-ark-hit == 'false' }}
      id: verify-ark
      continue-on-error: true
      shell: bash
      run: |
        if [ -f "extensions/positron-r/resources/ark/ark" ] && extensions/positron-r/resources/ark/ark --version 2>/dev/null; then
          echo "âœ… Ark binary verified and functional"
          echo "verified=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Ark binary missing or not functional - skipping cache save"
          echo "verified=false" >> $GITHUB_OUTPUT
        fi

    - name: Save Ark binary cache
      if: ${{ inputs.cache-ark-hit == 'false' && steps.verify-ark.outputs.verified == 'true' }}
      continue-on-error: true
      uses: actions/cache/save@v4
      with:
        path: |
          extensions/positron-r/resources/ark
        # IMPORTANT: If bumping ark -> ark-v2, also update restore-build-caches/action.yml
        key: ark-${{ runner.os }}-${{ inputs.distro }}-${{ hashFiles('extensions/positron-r/package.json') }}

    - name: Verify Kallichore binary before saving
      if: ${{ inputs.cache-kallichore-hit == 'false' }}
      id: verify-kallichore
      continue-on-error: true
      shell: bash
      run: |
        if [ -f "extensions/positron-supervisor/resources/kallichore/kcserver" ]; then
          echo "âœ… Kallichore binary verified"
          echo "verified=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Kallichore binary missing - skipping cache save"
          echo "verified=false" >> $GITHUB_OUTPUT
        fi

    - name: Save Kallichore binary cache
      if: ${{ inputs.cache-kallichore-hit == 'false' && steps.verify-kallichore.outputs.verified == 'true' }}
      continue-on-error: true
      uses: actions/cache/save@v4
      with:
        path: |
          extensions/positron-supervisor/resources/kallichore
        # IMPORTANT: If bumping kallichore-v3 -> kallichore-v4, also update restore-build-caches/action.yml
        key: kallichore-v3-${{ runner.os }}-${{ inputs.distro }}-${{ hashFiles('extensions/positron-supervisor/package.json') }}

    - name: Log cache save results
      if: always()
      shell: bash
      run: |
        # Track save status for summary
        ANY_SAVED=false

        # npm-core
        if [[ "${{ inputs.cache-npm-core-hit }}" == "false" ]]; then
          printf "%-16s %s\n" "npm-core" "ğŸ’¾ saved"
          ANY_SAVED=true
        elif [[ "${{ inputs.cache-npm-core-hit }}" == "true" ]]; then
          printf "%-16s %s\n" "npm-core" "âœ… skipped (already cached)"
        else
          printf "%-16s %s\n" "npm-core" "â­ï¸  skipped (not restored)"
        fi

        # npm-extensions
        if [[ "${{ inputs.cache-npm-extensions-hit }}" == "false" ]]; then
          printf "%-16s %s\n" "npm-extensions" "ğŸ’¾ saved"
          ANY_SAVED=true
        elif [[ "${{ inputs.cache-npm-extensions-hit }}" == "true" ]]; then
          printf "%-16s %s\n" "npm-extensions" "âœ… skipped (already cached)"
        else
          printf "%-16s %s\n" "npm-extensions" "â­ï¸  skipped (not restored)"
        fi

        # builtins
        if [[ "${{ inputs.cache-builtins-hit }}" == "false" ]]; then
          printf "%-16s %s\n" "builtins" "ğŸ’¾ saved"
          ANY_SAVED=true
        elif [[ "${{ inputs.cache-builtins-hit }}" == "true" ]]; then
          printf "%-16s %s\n" "builtins" "âœ… skipped (already cached)"
        else
          printf "%-16s %s\n" "builtins" "â­ï¸  skipped (not restored)"
        fi

        # ark
        if [[ "${{ inputs.cache-ark-hit }}" == "false" ]]; then
          if [[ "${{ steps.verify-ark.outputs.verified }}" == "true" ]]; then
            printf "%-16s %s\n" "ark" "ğŸ’¾ saved"
            ANY_SAVED=true
          else
            printf "%-16s %s\n" "ark" "âš ï¸  skipped (verification failed)"
            echo "::warning::Ark binary verification failed - cache not saved"
          fi
        elif [[ "${{ inputs.cache-ark-hit }}" == "true" ]]; then
          printf "%-16s %s\n" "ark" "âœ… skipped (already cached)"
        else
          printf "%-16s %s\n" "ark" "â­ï¸  skipped (not restored)"
        fi

        # kallichore
        if [[ "${{ inputs.cache-kallichore-hit }}" == "false" ]]; then
          if [[ "${{ steps.verify-kallichore.outputs.verified }}" == "true" ]]; then
            printf "%-16s %s\n" "kallichore" "ğŸ’¾ saved"
            ANY_SAVED=true
          else
            printf "%-16s %s\n" "kallichore" "âš ï¸  skipped (verification failed)"
            echo "::warning::Kallichore binary verification failed - cache not saved"
          fi
        elif [[ "${{ inputs.cache-kallichore-hit }}" == "true" ]]; then
          printf "%-16s %s\n" "kallichore" "âœ… skipped (already cached)"
        else
          printf "%-16s %s\n" "kallichore" "â­ï¸  skipped (not restored)"
        fi
