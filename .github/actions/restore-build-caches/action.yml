name: "Restore Build Caches"
description: "Restores caches for npm dependencies, Playwright browsers, Electron binaries, and built-in extensions."

# IMPORTANT: Cache paths must be kept in sync across 4 files:
# - .github/actions/restore-build-caches/action.yml (this file - Linux)
# - .github/actions/save-build-caches/action.yml (Linux)
# - .github/actions/restore-build-caches-windows/action.yml (Windows)
# - .github/actions/save-build-caches-windows/action.yml (Windows)
#
# When adding/modifying cache paths, update ALL 4 files to maintain restore/save parity.

inputs:
  distro:
    description: "Linux distribution identifier for cache key (default: ubuntu). Use 'rhel' for RHEL/Rocky Linux."
    required: false
    default: 'ubuntu'
  restore-npm:
    description: "Whether to restore npm cache (default: true)"
    required: false
    default: 'true'
  restore-builtins:
    description: "Whether to restore built-in extensions cache (default: true)"
    required: false
    default: 'true'
  restore-ark:
    description: "Whether to restore Ark binary cache (default: true)"
    required: false
    default: 'true'
  restore-kallichore:
    description: "Whether to restore Kallichore binary cache (default: true)"
    required: false
    default: 'true'

outputs:
  cache-npm-core-hit:
    description: "Whether npm core dependencies cache was restored"
    value: ${{ steps.cache-npm-core.outputs.cache-hit == 'true' && 'true' || 'false' }}
  cache-npm-extensions-hit:
    description: "Whether npm extensions cache was restored"
    value: ${{ steps.cache-npm-extensions.outputs.cache-hit == 'true' && 'true' || 'false' }}
  cache-builtins-hit:
    description: "Whether built-in extensions cache was restored"
    value: ${{ steps.cache-builtins.outputs.cache-hit == 'true' && 'true' || 'false' }}
  cache-ark-hit:
    description: "Whether Ark binary cache was restored"
    value: ${{ steps.cache-ark.outputs.cache-hit == 'true' && 'true' || 'false' }}
  cache-kallichore-hit:
    description: "Whether Kallichore binary cache was restored"
    value: ${{ steps.cache-kallichore.outputs.cache-hit == 'true' && 'true' || 'false' }}
  extensions-hash:
    description: "Generated hash of all extension package-lock.json files"
    value: ${{ steps.extensions-hash.outputs.hash }}
  package-locks-hash:
    description: "Computed hash of all package-lock.json files (for DRY cache key generation)"
    value: ${{ steps.package-locks-hash.outputs.hash }}

runs:
  using: "composite"
  steps:
    - name: Validate distro input
      shell: bash
      run: |
        if [[ "${{ runner.os }}" != "Linux" ]]; then
          echo "Error: restore-build-caches action is for Linux only. Use restore-build-caches-windows for Windows." >&2
          exit 1
        fi

    - name: Configure local caches
      shell: bash
      run: |
        echo "NPM_CONFIG_CACHE=.npm-cache" >> "$GITHUB_ENV"
        echo "PIP_CACHE_DIR=.pip-cache" >> "$GITHUB_ENV"
        mkdir -p .npm-cache .pip-cache .versions

    - name: Generate extensions cache key
      if: ${{ inputs.restore-npm == 'true' }}
      id: extensions-hash
      continue-on-error: true
      shell: bash
      # Generate a hash of all extension + .vscode package.json files
      run: .github/scripts/generate-extensions-hash.sh || echo "hash=fallback-$(date +%s)" >> "$GITHUB_OUTPUT"

    - name: Generate package-locks cache key
      if: ${{ inputs.restore-npm == 'true' }}
      id: package-locks-hash
      continue-on-error: true
      shell: bash
      # Automatically discovers package-lock.json files from build/npm/dirs.js
      # No manual list to maintain - just update dirs.js and cache keys update automatically!
      run: .github/scripts/generate-package-locks-hash.sh || echo "hash=fallback-$(date +%s)" >> "$GITHUB_OUTPUT"

    - name: Restore npm core dependencies cache
      if: ${{ inputs.restore-npm == 'true' }}
      id: cache-npm-core
      continue-on-error: true
      uses: actions/cache/restore@v4
      with:
        path: |
          .npm-cache
          node_modules
          build/node_modules
          remote/node_modules
          remote/web/node_modules
          remote/reh-web/node_modules
          test/integration/browser/node_modules
          test/monaco/node_modules
          test/mcp/node_modules
        # Core dependencies invalidate only when package-lock files change
        # Note: test/e2e/node_modules excluded - not in postinstall dirs.js, installed separately
        # IMPORTANT: If bumping npm-core-v4 -> npm-core-v5, also update save-build-caches/action.yml
        key: npm-core-v4-${{ runner.os }}-${{ inputs.distro }}-${{ steps.package-locks-hash.outputs.hash }}

    - name: Restore npm extensions cache
      if: ${{ inputs.restore-npm == 'true' }}
      id: cache-npm-extensions
      continue-on-error: true
      uses: actions/cache/restore@v4
      with:
        path: |
          extensions/**/node_modules
          .vscode/**/node_modules
          extensions/positron-assistant/resources
          extensions/positron-python/python-env-tools
          extensions/positron-python/python_files
        # Extensions invalidate when extension package.json files or git submodules change
        # Cache includes node_modules AND postinstall artifacts (binaries, Python libs, vendored packages)
        # Does NOT cache compiled outputs (out/) - extensions are recompiled during the "Compile Positron" step
        # IMPORTANT: If bumping npm-extensions-v6 -> npm-extensions-v7, also update save-build-caches/action.yml
        key: npm-extensions-v6-${{ runner.os }}-${{ inputs.distro }}-${{ steps.extensions-hash.outputs.hash }}

    - name: Restore built-in extensions cache
      if: ${{ inputs.restore-builtins == 'true' }}
      id: cache-builtins
      continue-on-error: true
      uses: actions/cache/restore@v4
      with:
        path: |
          .build/builtInExtensions
        # product.json contains the list and versions of built-in extensions
        # IMPORTANT: If bumping builtins -> builtins-v2, also update save-build-caches/action.yml
        key: builtins-${{ runner.os }}-${{ hashFiles('product.json') }}
        restore-keys: |
          builtins-${{ runner.os }}-

    - name: Restore Ark binary cache
      if: ${{ inputs.restore-ark == 'true' }}
      id: cache-ark
      continue-on-error: true
      uses: actions/cache/restore@v4
      with:
        path: |
          extensions/positron-r/resources/ark
        # Ark binary version is specified in positron-r package.json
        # IMPORTANT: If bumping ark -> ark-v2, also update save-build-caches/action.yml
        key: ark-${{ runner.os }}-${{ inputs.distro }}-${{ hashFiles('extensions/positron-r/package.json') }}
        restore-keys: |
          ark-${{ runner.os }}-${{ inputs.distro }}-

    - name: Log Ark version
      if: ${{ inputs.restore-ark == 'true' && steps.cache-ark.outputs.cache-hit == 'true' }}
      continue-on-error: true
      shell: bash
      run: |
        if [ -f "extensions/positron-r/resources/ark/ark" ]; then
          echo "Ark binary found, checking version..."
          ARK_VERSION=$(extensions/positron-r/resources/ark/ark --version 2>&1 || echo "version check failed")
          echo "Ark version: $ARK_VERSION"
        else
          echo "Ark binary not found at expected path"
        fi

    - name: Restore Kallichore binary cache
      if: ${{ inputs.restore-kallichore == 'true' }}
      id: cache-kallichore
      continue-on-error: true
      uses: actions/cache/restore@v4
      with:
        path: |
          extensions/positron-supervisor/resources/kallichore
        # Kallichore binary version is specified in positron-supervisor package.json
        # IMPORTANT: If bumping kallichore-v3 -> kallichore-v4, also update save-build-caches/action.yml
        key: kallichore-v3-${{ runner.os }}-${{ inputs.distro }}-${{ hashFiles('extensions/positron-supervisor/package.json') }}
        restore-keys: |
          kallichore-v3-${{ runner.os }}-${{ inputs.distro }}-

    - name: Log cache results
      if: always()
      shell: bash
      run: |
        # Track cache status for summary
        ALL_HIT=true
        ANY_MISS=false

        # npm-core
        if [[ "${{ inputs.restore-npm }}" == "true" ]]; then
          if [[ "${{ steps['cache-npm-core'].outputs['cache-hit'] }}" == "true" ]]; then
            printf "%-16s %s\n" "npm-core" "✅ hit"
          else
            printf "%-16s %s\n" "npm-core" "❌ miss"
            ALL_HIT=false
            ANY_MISS=true
          fi
        else
          printf "%-16s %s\n" "npm-core" "⏭️  skipped (disabled)"
        fi

        # npm-extensions
        if [[ "${{ inputs.restore-npm }}" == "true" ]]; then
          if [[ "${{ steps['cache-npm-extensions'].outputs['cache-hit'] }}" == "true" ]]; then
            printf "%-16s %s\n" "npm-extensions" "✅ hit"
          else
            printf "%-16s %s\n" "npm-extensions" "❌ miss"
            ALL_HIT=false
            ANY_MISS=true
          fi
        else
          printf "%-16s %s\n" "npm-extensions" "⏭️  skipped (disabled)"
        fi

        # builtins
        if [[ "${{ inputs.restore-builtins }}" == "true" ]]; then
          if [[ "${{ steps['cache-builtins'].outputs['cache-hit'] }}" == "true" ]]; then
            printf "%-16s %s\n" "builtins" "✅ hit"
          else
            printf "%-16s %s\n" "builtins" "❌ miss"
            ALL_HIT=false
            ANY_MISS=true
          fi
        else
          printf "%-16s %s\n" "builtins" "⏭️  skipped (disabled)"
        fi

        # ark
        if [[ "${{ inputs.restore-ark }}" == "true" ]]; then
          if [[ "${{ steps['cache-ark'].outputs['cache-hit'] }}" == "true" ]]; then
            printf "%-16s %s\n" "ark" "✅ hit"
          else
            printf "%-16s %s\n" "ark" "❌ miss"
            ALL_HIT=false
            ANY_MISS=true
          fi
        else
          printf "%-16s %s\n" "ark" "⏭️  skipped (disabled)"
        fi

        # kallichore
        if [[ "${{ inputs.restore-kallichore }}" == "true" ]]; then
          if [[ "${{ steps['cache-kallichore'].outputs['cache-hit'] }}" == "true" ]]; then
            printf "%-16s %s\n" "kallichore" "✅ hit"
          else
            printf "%-16s %s\n" "kallichore" "❌ miss"
            ALL_HIT=false
            ANY_MISS=true
          fi
        else
          printf "%-16s %s\n" "kallichore" "⏭️  skipped (disabled)"
        fi
