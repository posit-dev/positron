name: "Restore Build Caches"
description: "Restores caches for npm dependencies, Playwright browsers, Electron binaries, and built-in extensions."

inputs:
  distro:
    description: "Linux distribution identifier for cache key (default: ubuntu). Use 'rhel' for RHEL/Rocky Linux."
    required: false
    default: 'ubuntu'
  restore-npm:
    description: "Whether to restore npm cache (default: true)"
    required: false
    default: 'true'
  restore-playwright:
    description: "Whether to restore Playwright cache (default: true)"
    required: false
    default: 'true'
  restore-electron:
    description: "Whether to restore Electron cache (default: true)"
    required: false
    default: 'true'
  restore-builtins:
    description: "Whether to restore built-in extensions cache (default: true)"
    required: false
    default: 'true'

outputs:
  cache-playwright-hit:
    description: "Whether Playwright cache was restored"
    value: ${{ steps.cache-playwright.outputs.cache-hit == 'true' && 'true' || 'false' }}
  cache-npm-core-hit:
    description: "Whether npm core dependencies cache was restored"
    value: ${{ steps.cache-npm-core.outputs.cache-hit == 'true' && 'true' || 'false' }}
  cache-npm-extensions-hit:
    description: "Whether npm extensions cache was restored"
    value: ${{ steps.cache-npm-extensions.outputs.cache-hit == 'true' && 'true' || 'false' }}
  cache-electron-hit:
    description: "Whether Electron cache was restored"
    value: ${{ steps.cache-electron.outputs.cache-hit == 'true' && 'true' || 'false' }}
  cache-builtins-hit:
    description: "Whether built-in extensions cache was restored"
    value: ${{ steps.cache-builtins.outputs.cache-hit == 'true' && 'true' || 'false' }}
  extensions-hash:
    description: "Generated hash of all extension package-lock.json files"
    value: ${{ steps.extensions-hash.outputs.hash }}
  package-locks-hash:
    description: "Computed hash of all package-lock.json files (for DRY cache key generation)"
    value: ${{ steps.package-locks-hash.outputs.hash }}

runs:
  using: "composite"
  steps:
    - name: Validate distro input
      shell: bash
      run: |
        if [[ "${{ runner.os }}" != "Linux" ]]; then
          echo "Error: restore-build-caches action is for Linux only. Use restore-build-caches-windows for Windows." >&2
          exit 1
        fi

    - name: Configure local caches
      shell: bash
      run: |
        echo "NPM_CONFIG_CACHE=.npm-cache" >> "$GITHUB_ENV"
        echo "PIP_CACHE_DIR=.pip-cache" >> "$GITHUB_ENV"
        mkdir -p .npm-cache .pip-cache .versions

    - name: Generate extensions cache key
      if: ${{ inputs.restore-npm == 'true' }}
      id: extensions-hash
      continue-on-error: true
      shell: bash
      # Generate a hash of all extension + .vscode package.json files
      run: .github/scripts/generate-extensions-hash.sh || echo "hash=fallback-$(date +%s)" >> "$GITHUB_OUTPUT"

    - name: Generate package-locks cache key
      if: ${{ inputs.restore-npm == 'true' }}
      id: package-locks-hash
      continue-on-error: true
      shell: bash
      # Calculate hash of all package-lock.json files that get modified during postinstall
      # This is the single source of truth for which package-lock files to include in npm cache keys
      run: .github/scripts/generate-package-locks-hash.sh "${{ hashFiles('package-lock.json', 'build/package-lock.json', 'remote/package-lock.json', 'remote/web/package-lock.json', 'remote/reh-web/package-lock.json', 'test/e2e/package-lock.json', 'test/integration/browser/package-lock.json', 'test/monaco/package-lock.json', 'test/mcp/package-lock.json') }}" || echo "hash=fallback-$(date +%s)" >> "$GITHUB_OUTPUT"

    - name: Restore npm core dependencies cache
      if: ${{ inputs.restore-npm == 'true' }}
      id: cache-npm-core
      continue-on-error: true
      uses: actions/cache/restore@v4
      with:
        path: |
          .npm-cache
          node_modules
          build/node_modules
          remote/node_modules
          remote/web/node_modules
          remote/reh-web/node_modules
          test/e2e/node_modules
          test/integration/browser/node_modules
          test/monaco/node_modules
          test/mcp/node_modules
        # Core dependencies invalidate only when package-lock files change
        # IMPORTANT: If bumping npm-core-v1 -> npm-core-v2, also update save-build-caches/action.yml
        key: npm-core-v1-${{ runner.os }}-${{ inputs.distro }}-${{ steps.package-locks-hash.outputs.hash }}

    - name: Restore npm extensions cache
      if: ${{ inputs.restore-npm == 'true' }}
      id: cache-npm-extensions
      continue-on-error: true
      uses: actions/cache/restore@v4
      with:
        path: |
          extensions
          .vscode
        # Extensions invalidate when extension package.json files or git submodules change
        # IMPORTANT: If bumping npm-extensions-v1 -> npm-extensions-v2, also update save-build-caches/action.yml
        key: npm-extensions-v1-${{ runner.os }}-${{ inputs.distro }}-${{ steps.extensions-hash.outputs.hash }}

    - name: Extract Playwright version
      if: ${{ inputs.restore-playwright == 'true' }}
      id: playwright-version
      shell: bash
      run: |
        PLAYWRIGHT_VERSION=$(node -e "console.log(require('./package-lock.json').packages['node_modules/@playwright/test'].version)")
        echo "version=$PLAYWRIGHT_VERSION" >> "$GITHUB_OUTPUT"
        echo "Playwright version: $PLAYWRIGHT_VERSION"

    - name: Restore Playwright browsers cache
      if: ${{ inputs.restore-playwright == 'true' }}
      id: cache-playwright
      continue-on-error: true
      uses: actions/cache/restore@v4
      with:
        path: |
          ~/.cache/ms-playwright
          /root/.cache/ms-playwright
          /github/home/.cache/ms-playwright
        # Cache key tied directly to Playwright version for precision
        key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    - name: Restore Electron binary cache
      if: ${{ inputs.restore-electron == 'true' }}
      id: cache-electron
      continue-on-error: true
      uses: actions/cache/restore@v4
      with:
        path: |
          ~/.cache/electron
          ~/.cache/electron-builder
          /root/.cache/electron
          /root/.cache/electron-builder
          /github/home/.cache/electron
          /github/home/.cache/electron-builder
        # electron binaries are tied to package-lock and the electron version in package.json
        # IMPORTANT: If bumping electron -> electron-v2, also update save-build-caches/action.yml
        key: electron-${{ runner.os }}-${{ hashFiles('package-lock.json', 'package.json') }}
        restore-keys: |
          electron-${{ runner.os }}-

    - name: Restore built-in extensions cache
      if: ${{ inputs.restore-builtins == 'true' }}
      id: cache-builtins
      continue-on-error: true
      uses: actions/cache/restore@v4
      with:
        path: |
          .build/builtInExtensions
        # product.json contains the list and versions of built-in extensions
        # IMPORTANT: If bumping builtins -> builtins-v2, also update save-build-caches/action.yml
        key: builtins-${{ runner.os }}-${{ hashFiles('product.json') }}
        restore-keys: |
          builtins-${{ runner.os }}-

    - name: Log cache results
      if: always()
      shell: bash
      run: |
        echo "Cache results:"

        # npm-core
        if [[ "${{ inputs.restore-npm }}" == "true" ]]; then
          echo "  npm-core:       hit=${{ steps['cache-npm-core'].outputs['cache-hit'] || 'false' }}"
        else
          echo "  npm-core:       skipped (disabled)"
        fi

        # npm-extensions
        if [[ "${{ inputs.restore-npm }}" == "true" ]]; then
          echo "  npm-extensions: hit=${{ steps['cache-npm-extensions'].outputs['cache-hit'] || 'false' }}"
        else
          echo "  npm-extensions: skipped (disabled)"
        fi

        # playwright
        if [[ "${{ inputs.restore-playwright }}" == "true" ]]; then
          echo "  playwright:     hit=${{ steps['cache-playwright'].outputs['cache-hit'] || 'false' }}"
        else
          echo "  playwright:     skipped (disabled)"
        fi

        # electron
        if [[ "${{ inputs.restore-electron }}" == "true" ]]; then
          echo "  electron:       hit=${{ steps['cache-electron'].outputs['cache-hit'] || 'false' }}"
        else
          echo "  electron:       skipped (disabled)"
        fi

        # builtins
        if [[ "${{ inputs.restore-builtins }}" == "true" ]]; then
          echo "  builtins:       hit=${{ steps['cache-builtins'].outputs['cache-hit'] || 'false' }}"
        else
          echo "  builtins:       skipped (disabled)"
        fi
